"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{9670:(t,e,s)=>{s.r(e),s.d(e,{BECH32_REGEX:()=>tD,DEFAULT_ENCRYPTION_SCHEME:()=>V,NDKAppHandlerEvent:()=>t2,NDKAppSettings:()=>ec,NDKArticle:()=>tJ,NDKCashuMintList:()=>tK,NDKClassified:()=>tB,NDKDVMJobFeedback:()=>ei,NDKDVMJobResult:()=>ea,NDKDVMRequest:()=>er,NDKDraft:()=>t3,NDKDvmJobFeedbackStatus:()=>es,NDKEvent:()=>tp,NDKHighlight:()=>tY,NDKKind:()=>U,NDKList:()=>tj,NDKListKinds:()=>x,NDKNip07Signer:()=>eg,NDKNip46Backend:()=>eM,NDKNip46Signer:()=>eD,NDKNostrRpc:()=>ef,NDKNutzap:()=>eo,NDKPool:()=>tE,NDKPrivateKeySigner:()=>ey,NDKPublishError:()=>T,NDKRelay:()=>tv,NDKRelayAuthPolicies:()=>ep,NDKRelayList:()=>t0,NDKRelaySet:()=>S,NDKRelayStatus:()=>tw,NDKRepost:()=>t4,NDKSimpleGroup:()=>eu,NDKSimpleGroupMemberList:()=>eh,NDKSimpleGroupMetadata:()=>el,NDKSubscription:()=>tx,NDKSubscriptionCacheUsage:()=>tI,NDKSubscriptionReceipt:()=>ee,NDKSubscriptionStart:()=>et,NDKSubscriptionTier:()=>t8,NDKTranscriptionDVM:()=>en,NDKUser:()=>tG,NDKVideo:()=>tQ,NDKWiki:()=>tW,NDKZapper:()=>e3,NIP33_A_REGEX:()=>tM,calculateRelaySetFromEvent:()=>P,calculateTermDurationInSeconds:()=>t6,compareFilter:()=>tT,default:()=>eZ,defaultOpts:()=>tU,deserialize:()=>tr,dvmSchedule:()=>eC,eventHasETagMarkers:()=>Q,eventIsPartOfThread:()=>B,eventIsReply:()=>$,eventReplies:()=>W,eventThreadIds:()=>J,eventThreads:()=>G,eventsBySameAuthor:()=>K,filterAndRelaySetFromBech32:()=>tP,filterFingerprint:()=>tf,filterForEventsTaggingId:()=>tN,filterFromId:()=>tA,generateSubId:()=>tS,generateZapRequest:()=>e0,getEventReplyIds:()=>j,getNip57ZapSpecFromLud:()=>t$,getRelayListForUser:()=>eI,getRelayListForUsers:()=>eU,getReplyTag:()=>X,getRootEventId:()=>Y,getRootTag:()=>Z,isEventOriginalPost:()=>H,isNip33AValue:()=>t_,mergeFilters:()=>tm,newAmount:()=>t9,normalize:()=>b,normalizeRelayUrl:()=>m,normalizeUrl:()=>R,parseTagToSubscriptionAmount:()=>t7,pinEvent:()=>tH,possibleIntervalFrequencies:()=>t5,profileFromEvent:()=>tL,queryFullyFilled:()=>tR,relayListFromKind3:()=>t1,relaysFromBech32:()=>tC,serialize:()=>ti,serializeProfile:()=>tO,tryNormalizeRelayUrl:()=>f,zapInvoiceFromEvent:()=>eX});var i,r=s(6428),n=s(5875),a=s(9524),o=s(8775),h=s(3331),l=s(2232),u=s(9692),c=s(3947),d=s(7751);function p(t,e,s="write"){if(!t.outboxTracker)return;let i=t.outboxTracker.data.get(e);if(i)return"write"===s?i.writeRelays:i.readRelays}async function g(t,e,s="write"){if(t.outboxTracker)return t.outboxTracker.data.has(e)||await t.outboxTracker.trackUsers([e]),p(t,e,s)}function y(t,e,s,{count:i,preferredRelays:r}={}){i??=2,r??=new Set;let n=t.pool,a=n.connectedRelays();a.forEach(t=>{r.add(t.url)});let o=new Map,{pubkeysToRelays:h,authorsMissingRelays:l}=function(t,e,s="read"){let i=new Map,r=new Set;return e.forEach(e=>{let n=p(t,e,s);n&&n.size>0?(n.forEach(t=>{(i.get(t)||new Set).add(e)}),i.set(e,n)):r.add(e)}),{pubkeysToRelays:i,authorsMissingRelays:r}}(t,e,s),u=function(t,e){let s=new Map;return e.forEach(e=>{let i=p(t,e);i&&i.forEach(t=>{let e=s.get(t)||0;s.set(t,e+1)})}),Array.from(s.entries()).sort((t,e)=>e[1]-t[1]).map(t=>t[0])}(t,e),c=(t,e)=>{let s=o.get(e)||[];s.push(t),o.set(e,s)};for(let[t,e]of h.entries()){let s=i;for(let i of a)e.has(i.url)&&(c(t,i.url),s--);for(let i of e)o.has(i)&&(c(t,i),s--);if(!(s<=0))for(let i of u){if(s<=0)break;e.has(i)&&(c(t,i),s--)}}for(let t of l)n.permanentAndConnectedRelays().forEach(e=>{let s=o.get(e.url)||[];s.push(t),o.set(e.url,s)});return o}function f(t){try{return m(t)}catch{return}}function m(t){let e=R(t.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return e.endsWith("/")||(e+="/"),e}function b(t){let e=new Set;for(let s of t)try{e.add(m(s))}catch{}return Array.from(e)}var k=(t,e)=>e.some(e=>e instanceof RegExp?e.test(t):e===t),w=new Set(["https:","http:","file:"]),v=t=>{try{let{protocol:e}=new URL(t);return e.endsWith(":")&&!e.includes(".")&&!w.has(e)}catch{return!1}},E=(t,{stripHash:e})=>{let s=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(t);if(!s)throw Error(`Invalid URL: ${t}`);let i=s.groups?.type??"",r=s.groups?.data??"",n=s.groups?.hash??"",a=i.split(";");n=e?"":n;let o=!1;"base64"===a[a.length-1]&&(a.pop(),o=!0);let h=a.shift()?.toLowerCase()??"",l=[...a.map(t=>{let[e,s=""]=t.split("=").map(t=>t.trim());return"charset"===e&&"us-ascii"===(s=s.toLowerCase())?"":`${e}${s?`=${s}`:""}`}).filter(Boolean)];return o&&l.push("base64"),(l.length>0||h&&"text/plain"!==h)&&l.unshift(h),`data:${l.join(";")},${o?r.trim():r}${n?`#${n}`:""}`};function R(t,e={}){if("string"!=typeof(e={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...e}).defaultProtocol||e.defaultProtocol.endsWith(":")||(e.defaultProtocol=`${e.defaultProtocol}:`),t=t.trim(),/^data:/i.test(t))return E(t,e);if(v(t))return t;let s=t.startsWith("//");!s&&/^\.*\//.test(t)||(t=t.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,e.defaultProtocol));let i=new URL(t);if(e.forceHttp&&e.forceHttps)throw Error("The `forceHttp` and `forceHttps` options cannot be used together");if(e.forceHttp&&"https:"===i.protocol&&(i.protocol="http:"),e.forceHttps&&"http:"===i.protocol&&(i.protocol="https:"),e.stripAuthentication&&(i.username="",i.password=""),e.stripHash?i.hash="":e.stripTextFragment&&(i.hash=i.hash.replace(/#?:~:text.*?$/i,"")),i.pathname){let t=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g,e=0,s="";for(;;){let r=t.exec(i.pathname);if(!r)break;let n=r[0],a=r.index;s+=i.pathname.slice(e,a).replace(/\/{2,}/g,"/"),s+=n,e=a+n.length}s+=i.pathname.slice(e,i.pathname.length).replace(/\/{2,}/g,"/"),i.pathname=s}if(i.pathname)try{i.pathname=decodeURI(i.pathname)}catch{}if(!0===e.removeDirectoryIndex&&(e.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(e.removeDirectoryIndex)&&e.removeDirectoryIndex.length>0){let t=i.pathname.split("/");k(t[t.length-1],e.removeDirectoryIndex)&&(t=t.slice(0,-1),i.pathname=t.slice(1).join("/")+"/")}if(i.hostname&&(i.hostname=i.hostname.replace(/\.$/,""),e.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(i.hostname)&&(i.hostname=i.hostname.replace(/^www\./,""))),Array.isArray(e.removeQueryParameters))for(let t of[...i.searchParams.keys()])k(t,e.removeQueryParameters)&&i.searchParams.delete(t);if(Array.isArray(e.keepQueryParameters)||!0!==e.removeQueryParameters||(i.search=""),Array.isArray(e.keepQueryParameters)&&e.keepQueryParameters.length>0)for(let t of[...i.searchParams.keys()])k(t,e.keepQueryParameters)||i.searchParams.delete(t);if(e.sortQueryParameters){i.searchParams.sort();try{i.search=decodeURIComponent(i.search)}catch{}}e.removeTrailingSlash&&(i.pathname=i.pathname.replace(/\/$/,"")),e.removeExplicitPort&&i.port&&(i.port="");let r=t;return t=i.toString(),e.removeSingleSlash||"/"!==i.pathname||r.endsWith("/")||""!==i.hash||(t=t.replace(/\/$/,"")),(e.removeTrailingSlash||"/"===i.pathname)&&""===i.hash&&e.removeSingleSlash&&(t=t.replace(/\/$/,"")),s&&!e.normalizeProtocol&&(t=t.replace(/^http:\/\//,"//")),e.stripProtocol&&(t=t.replace(/^(?:https?:)?\/\//,"")),t}var T=class extends Error{errors;publishedToRelays;intendedRelaySet;constructor(t,e,s,i){super(t),this.errors=e,this.publishedToRelays=s,this.intendedRelaySet=i}get relayErrors(){let t=[];for(let[e,s]of this.errors)t.push(`${e.url}: ${s}`);return t.join("\n")}},S=class t{relays;debug;ndk;pool;constructor(t,e,s){this.relays=t,this.ndk=e,this.pool=s??e.pool,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(e,s,i=!0,r){if(!(r=r??s.pool))throw Error("No pool provided");let n=new Set;for(let t of e){let a=r.relays.get(m(t));if(a)a.status<5&&i&&a.connect(),n.add(a);else{let i=new tv(m(t),s?.relayAuthDefaultPolicy,s);r.useTemporaryRelay(i,void 0,"requested from fromRelayUrls "+e),n.add(i)}}return new t(new Set(n),s,r)}async publish(t,e,s=1){let i=new Set,r=new Map,n=t.isEphemeral();t.publishStatus="pending";let a=Array.from(this.relays).map(s=>new Promise(a=>{s.publish(t,e).then(t=>{i.add(s),a()}).catch(t=>{n||r.set(s,t),a()})}));if(await Promise.all(a),i.size<s){if(!n){let e=new T("Not enough relays received the event",r,i,this);throw t.publishStatus="error",t.publishError=e,this.ndk.emit("event:publish-failed",t,e,this.relayUrls),e}}else t.emit("published",{relaySet:this,publishedToRelays:i});return i}get size(){return this.relays.size}},N=n("ndk:outbox:calculate");async function P(t,e){let s=new Set,i=await g(t,e.pubkey);i&&i.forEach(e=>{let i=t.pool?.getRelay(e);i&&s.add(i)});let r=e.tags.filter(t=>["a","e"].includes(t[0])).map(t=>t[2]).filter(t=>t&&t.startsWith("wss://")).filter(t=>{try{return new URL(t),!0}catch{return!1}}).map(t=>m(t));(r=Array.from(new Set(r)).slice(0,5)).forEach(e=>{let i=t.pool?.getRelay(e,!0,!0);i&&(N("Adding relay hint %s",e),s.add(i))});let n=e.getMatchingTags("p").map(t=>t[1]);return n.length<5?Array.from(y(t,n,"read",{preferredRelays:new Set(i)}).keys()).forEach(e=>{let i=t.pool?.getRelay(e,!1,!0);i&&(N("Adding p-tagged relay %s",e),s.add(i))}):N("Too many p-tags to consider %d",n.length),t.pool?.permanentAndConnectedRelays().forEach(t=>s.add(t)),new S(s,t)}function A(t,e,s){return function(t,e,s){let i=new Map,r=new Set;if(e.forEach(t=>{t.authors&&t.authors.forEach(t=>r.add(t))}),r.size>0){let s=function(t,e,s=2){return y(t,e,"write",{count:s})}(t,Array.from(r));for(let t of s.keys())i.set(t,[]);for(let t of e)if(t.authors)for(let[e,r]of s.entries()){let s=t.authors.filter(t=>r.includes(t));i.set(e,[...i.get(e),{...t,authors:s}])}else for(let e of s.keys())i.set(e,[...i.get(e),t])}else t.explicitRelayUrls&&t.explicitRelayUrls.forEach(t=>{i.set(t,e)});return 0===i.size&&s.permanentAndConnectedRelays().slice(0,5).forEach(t=>{i.set(t.url,e)}),i}(t,e,s)}async function _(t,e=[]){let s=[],i=t=>{e.find(e=>["q",t[0]].includes(e[0])&&e[1]===t[1])||e.push(t)};return t=t.replace(/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,t=>{try{let e;let r=t.split(/(@|nostr:)/)[2],{type:n,data:o}=a.Qe.decode(r);switch(n){case"npub":e=["p",o];break;case"nprofile":e=["p",o.pubkey];break;case"note":s.push(new Promise(async t=>{i(["e",o,await M(r),"mention"]),t()}));break;case"nevent":s.push(new Promise(async t=>{let{id:e,author:s}=o,{relays:n}=o;n&&0!==n.length||(n=[await M(r)]),i(["e",e,n[0],"mention"]),s&&i(["p",s]),t()}));break;case"naddr":s.push(new Promise(async t=>{let e=[o.kind,o.pubkey,o.identifier].join(":"),s=o.relays??[];0===s.length&&(s=[await M(r)]),i(["a",e,s[0],"mention"]),i(["p",o.pubkey]),t()}));break;default:return t}return e&&i(e),`nostr:${r}`}catch(e){return t}}),await Promise.all(s),{content:t=t.replace(/(?<=\s|^)(#[^\s!@#$%^&*()=+./,[{\]};:'"?><]+)/g,(t,s)=>{let i=["t",s.slice(1)];return e.find(t=>t[0]===i[0]&&t[1]===i[1])||e.push(i),t}),tags:e}}async function M(t){return""}function D(){if(void 0===this.kind)throw Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function C(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function I(){if(void 0===this.kind)throw Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var U=(t=>(t[t.Metadata=0]="Metadata",t[t.Text=1]="Text",t[t.RecommendRelay=2]="RecommendRelay",t[t.Contacts=3]="Contacts",t[t.EncryptedDirectMessage=4]="EncryptedDirectMessage",t[t.EventDeletion=5]="EventDeletion",t[t.Repost=6]="Repost",t[t.Reaction=7]="Reaction",t[t.BadgeAward=8]="BadgeAward",t[t.GroupChat=9]="GroupChat",t[t.GroupNote=11]="GroupNote",t[t.GroupReply=12]="GroupReply",t[t.Image=20]="Image",t[t.GenericRespose=22]="GenericRespose",t[t.GenericRepost=16]="GenericRepost",t[t.ChannelCreation=40]="ChannelCreation",t[t.ChannelMetadata=41]="ChannelMetadata",t[t.ChannelMessage=42]="ChannelMessage",t[t.ChannelHideMessage=43]="ChannelHideMessage",t[t.ChannelMuteUser=44]="ChannelMuteUser",t[t.GenericReply=1111]="GenericReply",t[t.Media=1063]="Media",t[t.Report=1984]="Report",t[t.Label=1985]="Label",t[t.DVMReqTextExtraction=5e3]="DVMReqTextExtraction",t[t.DVMReqTextSummarization=5001]="DVMReqTextSummarization",t[t.DVMReqTextTranslation=5002]="DVMReqTextTranslation",t[t.DVMReqTextGeneration=5050]="DVMReqTextGeneration",t[t.DVMReqImageGeneration=5100]="DVMReqImageGeneration",t[t.DVMReqTextToSpeech=5250]="DVMReqTextToSpeech",t[t.DVMReqDiscoveryNostrContent=5300]="DVMReqDiscoveryNostrContent",t[t.DVMReqDiscoveryNostrPeople=5301]="DVMReqDiscoveryNostrPeople",t[t.DVMReqTimestamping=5900]="DVMReqTimestamping",t[t.DVMEventSchedule=5905]="DVMEventSchedule",t[t.DVMJobFeedback=7e3]="DVMJobFeedback",t[t.Subscribe=7001]="Subscribe",t[t.Unsubscribe=7002]="Unsubscribe",t[t.SubscriptionReceipt=7003]="SubscriptionReceipt",t[t.CashuReserve=7373]="CashuReserve",t[t.CashuQuote=7374]="CashuQuote",t[t.CashuToken=7375]="CashuToken",t[t.WalletChange=7376]="WalletChange",t[t.GroupAdminAddUser=9e3]="GroupAdminAddUser",t[t.GroupAdminRemoveUser=9001]="GroupAdminRemoveUser",t[t.GroupAdminEditMetadata=9002]="GroupAdminEditMetadata",t[t.GroupAdminEditStatus=9006]="GroupAdminEditStatus",t[t.GroupAdminCreateGroup=9007]="GroupAdminCreateGroup",t[t.GroupAdminRequestJoin=9021]="GroupAdminRequestJoin",t[t.MuteList=1e4]="MuteList",t[t.PinList=10001]="PinList",t[t.RelayList=10002]="RelayList",t[t.BookmarkList=10003]="BookmarkList",t[t.CommunityList=10004]="CommunityList",t[t.PublicChatList=10005]="PublicChatList",t[t.BlockRelayList=10006]="BlockRelayList",t[t.SearchRelayList=10007]="SearchRelayList",t[t.SimpleGroupList=10009]="SimpleGroupList",t[t.InterestList=10015]="InterestList",t[t.CashuMintList=10019]="CashuMintList",t[t.EmojiList=10030]="EmojiList",t[t.DirectMessageReceiveRelayList=10050]="DirectMessageReceiveRelayList",t[t.BlossomList=10063]="BlossomList",t[t.NostrWaletConnectInfo=13194]="NostrWaletConnectInfo",t[t.TierList=17e3]="TierList",t[t.FollowSet=3e4]="FollowSet",t[t.CategorizedPeopleList=3e4]="CategorizedPeopleList",t[t.CategorizedBookmarkList=30001]="CategorizedBookmarkList",t[t.RelaySet=30002]="RelaySet",t[t.CategorizedRelayList=30002]="CategorizedRelayList",t[t.BookmarkSet=30003]="BookmarkSet",t[t.CurationSet=30004]="CurationSet",t[t.ArticleCurationSet=30004]="ArticleCurationSet",t[t.VideoCurationSet=30005]="VideoCurationSet",t[t.ImageCurationSet=30006]="ImageCurationSet",t[t.InterestSet=30015]="InterestSet",t[t.InterestsList=30015]="InterestsList",t[t.EmojiSet=30030]="EmojiSet",t[t.ModularArticle=30040]="ModularArticle",t[t.ModularArticleItem=30041]="ModularArticleItem",t[t.Wiki=30818]="Wiki",t[t.Draft=31234]="Draft",t[t.SubscriptionTier=37001]="SubscriptionTier",t[t.EcashMintRecommendation=38e3]="EcashMintRecommendation",t[t.HighlightSet=39802]="HighlightSet",t[t.CategorizedHighlightList=39802]="CategorizedHighlightList",t[t.Nutzap=9321]="Nutzap",t[t.ZapRequest=9734]="ZapRequest",t[t.Zap=9735]="Zap",t[t.Highlight=9802]="Highlight",t[t.ClientAuth=22242]="ClientAuth",t[t.NostrWalletConnectReq=23194]="NostrWalletConnectReq",t[t.NostrWalletConnectRes=23195]="NostrWalletConnectRes",t[t.NostrConnect=24133]="NostrConnect",t[t.BlossomUpload=24242]="BlossomUpload",t[t.HttpAuth=27235]="HttpAuth",t[t.ProfileBadge=30008]="ProfileBadge",t[t.BadgeDefinition=30009]="BadgeDefinition",t[t.MarketStall=30017]="MarketStall",t[t.MarketProduct=30018]="MarketProduct",t[t.Article=30023]="Article",t[t.AppSpecificData=30078]="AppSpecificData",t[t.Classified=30402]="Classified",t[t.HorizontalVideo=34235]="HorizontalVideo",t[t.VerticalVideo=34236]="VerticalVideo",t[t.CashuWallet=37375]="CashuWallet",t[t.GroupMetadata=39e3]="GroupMetadata",t[t.GroupAdmins=39001]="GroupAdmins",t[t.GroupMembers=39002]="GroupMembers",t[t.AppRecommendation=31989]="AppRecommendation",t[t.AppHandler=31990]="AppHandler",t))(U||{}),x=[1e4,10001,10002,10003,10004,10005,10006,10007,10015,10030,10050,3e4,30003,30001,30002,30004,30005,30015,30030,39802],V="nip44";async function L(t,e,s=V){if(!this.ndk)throw Error("No NDK instance found!");if(e||(await this.ndk.assertSigner(),e=this.ndk.signer),!t){let e=this.getMatchingTags("p");if(1!==e.length)throw Error("No recipient could be determined and no explicit recipient was provided");t=this.ndk.getUser({pubkey:e[0][1]})}this.content=await e?.encrypt(t,this.content,s)}async function O(t,e,s){if(!this.ndk)throw Error("No NDK instance found!");e||(await this.ndk.assertSigner(),e=this.ndk.signer),t||(t=this.author),s||(s=this.content.match(/\?iv=/)?"nip04":"nip44"),this.content=await e?.decrypt(t,this.content,s)}function z(t=2){let e=[];return(this.onRelays.length>0?e=this.onRelays.map(t=>t.url):this.relay&&(e=[this.relay.url]),e.length>t&&(e=e.slice(0,t)),this.isParamReplaceable())?a.Qe.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:e}):e.length>0?a.Qe.neventEncode({id:this.tagId(),relays:e,author:this.pubkey}):a.Qe.noteEncode(this.tagId())}async function F(t=!0,e){if(!e&&t){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),e=this.ndk.signer}let s=new tp(this.ndk,{kind:1===this.kind?6:16});return s.content=JSON.stringify(this.rawEvent()),s.tag(this),1!==this.kind&&s.tags.push(["k",`${this.kind}`]),e&&await s.sign(e),t&&await s.publish(),s}function K(t,e){let s=new Map;return s.set(t.id,t),e.forEach(e=>{e.pubkey===t.pubkey&&s.set(e.id,e)}),s}var q=(t,e)=>t.getMatchingTags(e).some(t=>t[3]&&""!==t[3]);function $(t,e,s=new Set,i){i??=t.tagType();let r=e.getMatchingTags(i);if(s.add(t.tagId()),s.has(e.tagId()))return!1;let n=(()=>{let e=!1;for(let i of r){if("reply"===i[3])return s.has(i[1]);let r=""===i[3]||void 0===i[3],n="root"===i[3];i[1]===t.tagId()&&(r||n)&&(e=!n||"root")}return!!e&&("root"===e||void 0)})();if(void 0!==n)return n;if(q(e,i))return!1;let a=t.getMatchingTags("e").map(t=>t[1]);return a.push(t.id),e.getMatchingTags("e").every(t=>a.includes(t[1]))}function G(t,e){let s=K(t,e);return e.filter(e=>B(t,e,s)).sort((t,e)=>t.created_at-e.created_at)}function j(t){if(!q(t,t.tagType()))return t.getMatchingTags("e").map(t=>t[1]);{let e;let s=[];return t.getMatchingTags(t.tagType()).forEach(t=>{"root"===t[3]&&(e=t),"reply"===t[3]&&s.push(t)}),0===s.length&&e&&s.push(e),s.map(t=>t[1])}}function H(t){return 0===j(t).length}function J(t,e){let s=new Map;return G(t,e).forEach(t=>s.set(t.id,t)),s}function W(t,e,s){return s??=new Set(J(t,e).keys()),e.filter(e=>$(t,e,s))}function B(t,e,s){return t.pubkey===e.pubkey&&e.getMatchingTags("e").map(t=>t[1]).every(t=>s.has(t))}function Q(t){return t.getMatchingTags("e").some(t=>t[3])}function Y(t,e){e??=t.tagType();let s=Z(t,e);if(s)return s[1];let i=X(t,e);return i?.[1]}function Z(t,e){e??=t.tagType();let s=t.tags.find(t=>"root"===t[3]);if(!s){if(Q(t))return;let s=t.getMatchingTags(e);if(s.length<3)return s[0]}return s}function X(t,e){e??=t.tagType();let s=t.tags.find(t=>"reply"===t[3]);if(s)return s;if(s||(s=t.tags.find(t=>"root"===t[3])),!s){if(Q(t))return;let s=t.getMatchingTags(e);if(1===s.length)return s[0];if(2===s.length)return s[1]}}async function tt(t,e){let s;if(!this.ndk)throw Error("NDK instance not found");let i=this.getMatchingTags(t,e);if(0===i.length)return;let[r,n,a]=i[0];return await this.ndk.fetchEvent(n,{},s)}async function te(t){if(!this.ndk)throw Error("NDK instance not found");let e=Z(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}async function ts(t){if(!this.ndk)throw Error("NDK instance not found");let e=X(this);if(e)return this.ndk.fetchEventFromTag(e,this,t)}function ti(t=!1,e=!1){let s=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return t&&s.push(this.sig),e&&s.push(this.id),JSON.stringify(s)}function tr(t){let e=JSON.parse(t),s={pubkey:e[1],created_at:e[2],kind:e[3],tags:e[4],content:e[5]};return e.length>=7&&(s.sig=e[6]),e.length>=8&&(s.id=e[7]),s}var tn={};async function ta(t,e){return new Promise(e=>{let s=t.serialize(),r=!1;tn[t.id]||(tn[t.id]={event:t,resolves:[]},r=!0),tn[t.id].resolves.push(e),r&&i.postMessage({serialized:s,id:t.id,sig:t.sig,pubkey:t.pubkey})})}var to=/^[a-f0-9]{64}$/;function th(){if("number"!=typeof this.kind||"string"!=typeof this.content||"number"!=typeof this.created_at||"string"!=typeof this.pubkey||!this.pubkey.match(to)||!Array.isArray(this.tags))return!1;for(let t=0;t<this.tags.length;t++){let e=this.tags[t];if(!Array.isArray(e))return!1;for(let t=0;t<e.length;t++)if("object"==typeof e[t])return!1}return!0}var tl=new u.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function tu(t){if("boolean"==typeof this.signatureVerified)return this.signatureVerified;let e=tl.get(this.id);if(null!==e)return this.signatureVerified=!!e;try{if(this.ndk?.asyncSigVerification)ta(this,t).then(e=>{t&&(this.signatureVerified=e,e&&tl.set(this.id,this.sig)),e||(this.ndk.emit("event:invalid-sig",this),tl.set(this.id,!1))});else{let t=(0,o.sc)(new TextEncoder().encode(this.serialize())),e=l.ko.verify(this.sig,t,this.pubkey);return e?tl.set(this.id,this.sig):tl.set(this.id,!1),this.signatureVerified=e}}catch(t){return this.signatureVerified=!1}}function tc(){return function(t){let e=(0,o.sc)(new TextEncoder().encode(t));return(0,h.My)(e)}(this.serialize())}var td=[3],tp=class t extends r.EventEmitter{ndk;created_at;content="";tags=[];kind;id="";sig;pubkey="";signatureVerified;_author=void 0;relay;get onRelays(){let t=[];return this.ndk?t=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&t.push(this.relay),t}publishStatus="success";publishError;constructor(e,s){super(),this.ndk=e,this.created_at=s?.created_at,this.content=s?.content||"",this.tags=s?.tags||[],this.id=s?.id||"",this.sig=s?.sig,this.pubkey=s?.pubkey||"",this.kind=s?.kind,s instanceof t&&(this.relay&&(this.relay=s.relay,this.ndk?.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}static deserialize(e,s){return new t(e,tr(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(t){this.pubkey=t.pubkey,this._author=t,this._author.ndk??=this.ndk}get author(){if(this._author)return this._author;if(!this.ndk)throw Error("No NDK instance found");let t=this.ndk.getUser({pubkey:this.pubkey});return this._author=t,t}tagExternal(t,e,s){let i=["i"],r=["k"];switch(e){case"url":let n=new URL(t);n.hash="",i.push(n.toString()),r.push(`${n.protocol}//${n.host}`);break;case"hashtag":i.push(`#${t.toLowerCase()}`),r.push("#");break;case"geohash":i.push(`geo:${t.toLowerCase()}`),r.push("geo");break;case"isbn":i.push(`isbn:${t.replace(/-/g,"")}`),r.push("isbn");break;case"podcast:guid":i.push(`podcast:guid:${t}`),r.push("podcast:guid");break;case"podcast:item:guid":i.push(`podcast:item:guid:${t}`),r.push("podcast:item:guid");break;case"podcast:publisher:guid":i.push(`podcast:publisher:guid:${t}`),r.push("podcast:publisher:guid");break;case"isan":i.push(`isan:${t.split("-").slice(0,4).join("-")}`),r.push("isan");break;case"doi":i.push(`doi:${t.toLowerCase()}`),r.push("doi");break;default:throw Error(`Unsupported NIP-73 entity type: ${e}`)}s&&i.push(s),this.tags.push(i),this.tags.push(r)}tag(e,s,i,r){let n=[];if(void 0!==e.fetchProfile){let t=[r??="p",e.pubkey];s&&t.push("",s),n.push(t)}else if(e instanceof t)for(let t of(i??=e?.pubkey===this.pubkey,n=e.referenceTags(s,i,r),e.getMatchingTags("p")))t[1]!==this.pubkey&&(this.tags.find(e=>"p"===e[0]&&e[1]===t[1])||this.tags.push(["p",t[1]]));else if(Array.isArray(e))n=[e];else throw Error("Invalid argument",e);this.tags=function(t,e){let s=new Map,i=t=>t.join(","),r=(t,e)=>t.every((t,s)=>t===e[s]);return t.concat(e).forEach(t=>{for(let[e,i]of s)if(r(i,t)||r(t,i)){t.length>=i.length&&s.set(e,t);return}s.set(i(t),t)}),Array.from(s.values())}(this.tags,n)}async toNostrEvent(t){if(!t&&""===this.pubkey){let t=await this.ndk?.signer?.user();this.pubkey=t?.pubkey||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));let{content:e,tags:s}=await this.generateTags();this.content=e||"",this.tags=s;try{this.id=this.getEventHash()}catch(t){}return this.rawEvent()}serialize=ti.bind(this);getEventHash=tc.bind(this);validate=th.bind(this);verifySignature=tu.bind(this);isReplaceable=D.bind(this);isEphemeral=C.bind(this);isParamReplaceable=I.bind(this);encode=z.bind(this);encrypt=L.bind(this);decrypt=O.bind(this);getMatchingTags(t,e){let s=this.tags.filter(e=>e[0]===t);return void 0===e?s:s.filter(t=>t[3]===e)}hasTag(t,e){return this.tags.some(s=>s[0]===t&&(!e||s[3]===e))}tagValue(t){let e=this.getMatchingTags(t);if(0!==e.length)return e[0][1]}get alt(){return this.tagValue("alt")}set alt(t){this.removeTag("alt"),t&&this.tags.push(["alt",t])}get dTag(){return this.tagValue("d")}set dTag(t){this.removeTag("d"),t&&this.tags.push(["d",t])}removeTag(t){let e=Array.isArray(t)?t:[t];this.tags=this.tags.filter(t=>!e.includes(t[0]))}async sign(t){t?this.author=await t.user():(this.ndk?.assertSigner(),t=this.ndk.signer);let e=await this.toNostrEvent();return this.sig=await t.sign(e),this.sig}async publishReplaceable(t,e,s){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(t,e,s)}async publish(t,e,s){if(this.sig||await this.sign(),!this.ndk)throw Error("NDKEvent must be associated with an NDK instance to publish");if(t||(t=this.ndk.devWriteRelaySet||await P(this.ndk,this)),5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds){let t=this.getMatchingTags("e").map(t=>t[1]);this.ndk.cacheAdapter.deleteEventIds(t)}let i=this.rawEvent();if(this.ndk.cacheAdapter?.addUnpublishedEvent)try{this.ndk.cacheAdapter.addUnpublishedEvent(this,t.relayUrls)}catch(t){console.error("Error adding unpublished event to cache",t)}5===this.kind&&this.ndk.cacheAdapter?.deleteEventIds&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(t=>t[1])),this.ndk.subManager.dispatchEvent(i,void 0,!0);let r=await t.publish(this,e,s);return r.forEach(t=>this.ndk?.subManager.seenEvent(this.id,t)),r}async generateTags(){let t=[],e=await _(this.content,this.tags),s=e.content;if(t=e.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){let e=this.tagValue("title"),s=[...Array(e?6:16)].map(()=>Math.random().toString(36)[2]).join("");e&&e.length>0&&(s=e.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+s),t.push(["d",s])}if(this.shouldAddClientTag){let e=["client",this.ndk.clientName??""];this.ndk.clientNip89&&e.push(this.ndk.clientNip89),t.push(e)}else t=t.filter(t=>"client"!==t[0]);return{content:s||"",tags:t}}get shouldAddClientTag(){return!(!this.ndk?.clientName&&!this.ndk?.clientNip89||td.includes(this.kind)||this.isEphemeral()||this.hasTag("client"))}muted(){let t=this.ndk?.mutedIds.get(this.pubkey);if(t&&"p"===t)return"author";let e=this.tagReference(),s=this.ndk?.mutedIds.get(e[1]);return s&&s===e[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){let t=this.getMatchingTags("d")[0];return t?t[1]:""}throw Error("Event is not a parameterized replaceable event")}deduplicationKey(){return 0===this.kind||3===this.kind||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw Error("This must only be called on replaceable events");let t=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${t}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(t){let e;return e=this.isParamReplaceable()?["a",this.tagAddress()]:["e",this.tagId()],this.relay?e.push(this.relay.url):e.push(""),e.push(t??""),this.isParamReplaceable()||e.push(this.pubkey),e}referenceTags(t,e,s){let i=[];return(i=(i=this.isParamReplaceable()?[[s??"a",this.tagAddress()],[s??"e",this.id]]:[[s??"e",this.id]]).map(e=>("e"===e[0]||t?e.push(this.relay?.url??""):this.relay?.url&&e.push(this.relay?.url),e))).forEach(e=>{"e"===e[0]?(e.push(t??""),e.push(this.pubkey)):t&&e.push(t)}),i=[...i,...this.getMatchingTags("h")],e||i.push(...this.author.referenceTags()),i}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async delete(e,s=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let i=new t(this.ndk,{kind:5,content:e||""});return i.tag(this,void 0,!0),i.tags.push(["k",this.kind.toString()]),s&&(this.emit("deleted"),await i.publish()),i}fetchTaggedEvent=tt.bind(this);fetchRootEvent=te.bind(this);fetchReplyEvent=ts.bind(this);repost=F.bind(this);async react(e,s=!0){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner();let i=new t(this.ndk,{kind:7,content:e});return i.tag(this),s?await i.publish():await i.sign(),i}get isValid(){return this.validate()}reply(){let e=new t(this.ndk);if(1===this.kind)e.kind=1,this.hasTag("e")?e.tags=[...e.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply")]:e.tag(this,"root");else{e.kind=1111;let t=["A","E","I","P"],s=this.tags.filter(e=>t.includes(e[0]));if(s.length>0){let t=this.tagValue("K");e.tags.push(...s),t&&e.tags.push(["K",t]);let[i,r,n,...a]=this.tagReference(),o=[i,r,...a];e.tags.push(o)}else{let[t,s,i,r]=this.tagReference(),n=[t,s,r??""];"e"===t&&n.push(this.pubkey),e.tags.push(n);let a=[...n];a[0]=a[0].toUpperCase(),e.tags.push(a),e.tags.push(["K",this.kind.toString()]),e.tags.push(["P",this.pubkey])}e.tags.push(["k",this.kind.toString()]),e.tags.push(...this.getMatchingTags("p")),e.tags.push(["p",this.pubkey])}return e}},tg=class{ndkRelay;ws;_status;timeoutMs;connectedAt;_connectionStats={attempts:0,success:0,durations:[]};debug;netDebug;connectTimeout;reconnectTimeout;ndk;openSubs=new Map;openCountRequests=new Map;openEventPublishes=new Map;serial=0;baseEoseTimeout=4400;constructor(t,e){this.ndkRelay=t,this._status=1;let s=Math.floor(1e3*Math.random());this.debug=this.ndkRelay.debug.extend("connectivity"+s),this.ndk=e}async connect(t,e=!0){if(2!==this._status&&1!==this._status||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??=this.timeoutMs,!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),1===this._status?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(t){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,t),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",1728e5),t}}disconnect(){this._status=0;try{this.ws?.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.netDebug?.("connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.netDebug?.("disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),5===this._status&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){this.netDebug?.(t.data,this.ndkRelay,"recv");try{let e=JSON.parse(t.data),[s,i,...r]=e;switch(s){case"EVENT":{let t=this.openSubs.get(i),s=e[2];if(!t){this.debug(`Received event for unknown subscription ${i}`);return}t.onevent(s);return}case"COUNT":{let t=e[2],s=this.openCountRequests.get(i);s&&(s.resolve(t.count),this.openCountRequests.delete(i));return}case"EOSE":{let t=this.openSubs.get(i);if(!t)return;t.oneose(i);return}case"OK":{let t=e[2],s=e[3],r=this.openEventPublishes.get(i),n=r?.pop();if(!r||!n){this.debug("Received OK for unknown event publish",i);return}t?n.resolve(s):n.reject(Error(s)),0===r.length?this.openEventPublishes.delete(i):this.openEventPublishes.set(i,r);return}case"CLOSED":{let t=this.openSubs.get(i);if(!t)return;t.onclosed(e[2]);return}case"NOTICE":this.onNotice(e[1]);return;case"AUTH":this.onAuthRequested(e[1]);return}}catch(t){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t?.stack);return}}async onAuthRequested(t){let e=this.ndkRelay.authPolicy??this.ndk?.relayAuthDefaultPolicy;if(this.debug("Relay requested authentication",{havePolicy:!!e}),7===this._status){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){let s;this._status=7;try{s=await e(this.ndkRelay,t)}catch(t){this.debug("Authentication policy threw an error",t),s=!1}if(this.debug("Authentication policy returned",!!s),s instanceof tp||!0===s){s instanceof tp&&await this.auth(s);let e=async()=>{if(this._status>=5&&this._status<8){let e=new tp(this.ndk);e.kind=22242,e.tags=[["relay",this.ndkRelay.url],["challenge",t]],await e.sign(),this.auth(e).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(t=>{this._status=6,this.ndkRelay.emit("auth:failed",t),this.debug("Authentication failed",t)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};!0===s&&(this.ndk?.signer?e().catch(t=>{console.error("Error authenticating",t)}):(this.debug("No signer available for authentication localhost"),this.ndk?.once("signer:ready",e))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return 5===this._status}isFlapping(){let t=this._connectionStats.durations;if(t.length%3!=0)return!1;let e=t.reduce((t,e)=>t+e,0)/t.length;return 1e3>Math.sqrt(t.map(t=>Math.pow(t-e,2)).reduce((t,e)=>t+e,0)/t.length)}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(e=>{t<5?setTimeout(()=>{this.handleReconnection(t+1)},1e3*(t+1)^4):this.debug("Reconnect failed")})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){this._status>=5&&this.ws?.readyState===WebSocket.OPEN?(this.ws?.send(t),this.netDebug?.(t,this.ndkRelay,"send")):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status)}async auth(t){let e=new Promise((e,s)=>{let i=this.openEventPublishes.get(t.id)??[];i.push({resolve:e,reject:s}),this.openEventPublishes.set(t.id,i)});return this.send('["AUTH",'+JSON.stringify(t.rawEvent())+"]"),e}async publish(t){let e=new Promise((e,s)=>{let i=this.openEventPublishes.get(t.id)??[];i.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+t.id+" twice"),i.push({resolve:e,reject:s}),this.openEventPublishes.set(t.id,i)});return this.send('["EVENT",'+JSON.stringify(t)+"]"),e}async count(t,e){this.serial++;let s=e?.id||"count:"+this.serial,i=new Promise((t,e)=>{this.openCountRequests.set(s,{resolve:t,reject:e})});return this.send('["COUNT","'+s+'",'+JSON.stringify(t).substring(1)),i}close(t,e){this.send('["CLOSE","'+t+'"]');let s=this.openSubs.get(t);this.openSubs.delete(t),s&&s.onclose(e)}req(t){this.send('["REQ","'+t.subId+'",'+JSON.stringify(t.executeFilters).substring(1)),this.openSubs.set(t.subId,t)}updateConnectionStats={connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}};get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){return this._status>=5&&this.ws?.readyState===WebSocket.OPEN}},ty=class{ndkRelay;debug;constructor(t){this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let s,i,r;let n=()=>new Promise((e,s)=>{try{this.publishEvent(t).then(s=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),e(!0)}).catch(s)}catch(t){s(t)}}),a=new Promise((t,i)=>{s=setTimeout(()=>{s=void 0,i(Error("Timeout: "+e+"ms"))},e)}),o=()=>{n().then(t=>i(t)).catch(t=>r(t))},h=e=>{throw this.ndkRelay.debug("Publish failed",e,t.id),this.ndkRelay.emit("publish:failed",t,e),t.emit("relay:publish:failed",this.ndkRelay,e),e},l=()=>{s&&clearTimeout(s),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([n(),a]).catch(h).finally(l):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((t,e)=>{i=t,r=e,this.ndkRelay.once("connect",o)}),a]).catch(h).finally(l))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function tf(t,e){let s=[];for(let e of t){let t=Object.entries(e||{}).map(([t,e])=>["since","until"].includes(t)?t+":"+e:t).sort().join("-");s.push(t)}return(e?"+":"")+s.join("|")}function tm(t){let e=[],s={};return(t.filter(t=>!!t.limit).forEach(t=>e.push(t)),0===(t=t.filter(t=>!t.limit)).length)?e:(t.forEach(t=>{Object.entries(t).forEach(([t,e])=>{Array.isArray(e)?void 0===s[t]?s[t]=[...e]:s[t]=Array.from(new Set([...s[t],...e])):s[t]=e})}),[...e,s])}var tb=class{fingerprint;items=new Map;topSubManager;debug;status=0;onClose;relay;eosed=!1;executionTimer;fireTime;delayType;executeFilters;id=Math.random().toString(36).substring(7);constructor(t,e,s){this.relay=t,this.topSubManager=s,this.debug=t.debug.extend("subscription-"+this.id),this.fingerprint=e||Math.random().toString(36).substring(7)}_subId;get subId(){return this._subId||(this._subId=this.fingerprint.slice(0,15)),this._subId}subIdParts=new Set;addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:e,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),3!==this.status&&t.subId&&(!this._subId||this._subId.length<48)&&(0===this.status||1===this.status)&&this.addSubIdPart(t.subId),this.status){case 0:case 1:this.evaluateExecutionPlan(t);break;case 3:console.log("BUG: This should not happen: This subscription needs to catch up with a subscription that was already running",e);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",t,e),Error("Cannot add new items to a closed subscription")}}removeItem(t){this.items.delete(t.internalId),0===this.items.size&&this.eosed&&(this.close(),this.cleanup())}close(){if(4===this.status)return;let t=this.status;if(this.status=4,3===t)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()||t.filters.find(t=>!!t.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}let e=t.groupableDelay,s=t.groupableDelayType;if(!e)throw Error("Cannot group a subscription without a delay");if(0===this.status)this.schedule(e,s);else{let t=this.delayType,i=this.fireTime-Date.now();if("at-least"===t&&"at-least"===s)i<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if("at-least"===t&&"at-most"===s)i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if("at-most"===t&&"at-most"===s)i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if("at-most"===t&&"at-least"===s)i>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else throw Error("Unknown delay type combination "+t+" "+s)}}schedule(t,e){this.status=1;let s=Date.now();this.fireTime=s+t,this.delayType=e;let i=setTimeout(this.execute.bind(this),t);"at-least"===e&&(this.executionTimer=i)}executeOnRelayReady=()=>{if(2===this.status){if(0===this.items.size){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}};finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}reExecuteAfterAuth=(()=>{let t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s \uD83D\uDC49 %s",t,this.subId)}).bind(this);execute(){if(1===this.status){if(this.relay.connected)this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth);else{this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}for(let{subscription:t}of(0===this.items.size&&this.close(),this.items.values()))t.eoseReceived(this.relay),t.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:t.filters,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(t))}onclose(t){this.status=4}onclosed(t){if(t)for(let{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){let t=[],e=Array.from(this.items.values()).map(t=>t.filters);if(!e[0])return this.debug("\uD83D\uDC40 No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];let s=e[0].length;for(let i=0;i<s;i++){let s=e.map(t=>t[i]);t.push(...tm(s))}return t}},tk=class{relay;subscriptions;generalSubManager;constructor(t,e){this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let s;if(t.isGroupable()){let i=tf(e,t.closeOnEose);i&&(s=(this.subscriptions.get(i)||[]).find(t=>t.status<3)),s??=this.createSubscription(t,e,i)}else s=this.createSubscription(t,e);s.addItem(t,e)}createSubscription(t,e,s){let i=new tb(this.relay,s||null,this.generalSubManager);i.onClose=this.onRelaySubscriptionClose.bind(this);let r=this.subscriptions.get(i.fingerprint)??[];return this.subscriptions.set(i.fingerprint,[...r,i]),i}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?1===e.length?this.subscriptions.delete(t.fingerprint):(e=e.filter(e=>e.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},tw=(t=>(t[t.DISCONNECTING=0]="DISCONNECTING",t[t.DISCONNECTED=1]="DISCONNECTED",t[t.RECONNECTING=2]="RECONNECTING",t[t.FLAPPING=3]="FLAPPING",t[t.CONNECTING=4]="CONNECTING",t[t.CONNECTED=5]="CONNECTED",t[t.AUTH_REQUESTED=6]="AUTH_REQUESTED",t[t.AUTHENTICATING=7]="AUTHENTICATING",t[t.AUTHENTICATED=8]="AUTHENTICATED",t))(tw||{}),tv=class t extends r.EventEmitter{url;scores;connectivity;subs;publisher;authPolicy;lowestValidationRatio;targetValidationRatio;validationRatioFn;validatedEventCount=0;nonValidatedEventCount=0;trusted=!1;complaining=!1;debug;static defaultValidationRatioUpdateFn=(t,e,s)=>{if(void 0===t.lowestValidationRatio||void 0===t.targetValidationRatio)return 1;let i=t.validationRatio;return(t.validationRatio>t.targetValidationRatio&&(i=Math.max(t.lowestValidationRatio,t.validationRatio-e/100)),i<t.validationRatio)?i:t.validationRatio};constructor(e,s,i){super(),this.url=m(e),this.scores=new Map,this.debug=n(`ndk:relay:${e}`),this.connectivity=new tg(this,i),this.connectivity.netDebug=i?.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new tk(this,i.subManager),this.publisher=new ty(this),this.authPolicy=s,this.targetValidationRatio=i?.initialValidationRatio,this.lowestValidationRatio=i?.lowestValidationRatio,this.validationRatioFn=(i?.validationRatioFn??t.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),i||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(t,e=!0){return this.connectivity.connect(t,e)}disconnect(){1!==this.status&&this.connectivity.disconnect()}subscribe(t,e){this.subs.addSubscription(t,e)}async publish(t,e=2500){return this.publisher.publish(t,e)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return 0===this.nonValidatedEventCount?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return!this.trusted&&(void 0===this.targetValidationRatio||this.validationRatio<this.targetValidationRatio)}get connected(){return this.connectivity.connected}req;close},tE=class extends r.EventEmitter{_relays=new Map;autoConnectRelays=new Set;blacklistRelayUrls;debug;temporaryRelayTimers=new Map;flappingRelays=new Set;backoffTimes=new Map;ndk;constructor(t=[],e=[],s,i){super(),this.debug=i??s.debug.extend("pool"),this.ndk=s,this.relayUrls=t,this.blacklistRelayUrls=new Set(e)}get relays(){return this._relays}set relayUrls(t){for(let e of(this._relays.clear(),t)){let t=new tv(e,void 0,this.ndk);t.connectivity.netDebug=this.ndk.netDebug,this.addRelay(t,!1)}}set name(t){this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,s){let i=this.relays.has(t.url);i||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,s));let r=this.temporaryRelayTimers.get(t.url);if(r&&clearTimeout(r),!i||r){let s=setTimeout(()=>{this.ndk.explicitRelayUrls?.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,s)}}addRelay(t,e=!0){let s=this.relays.has(t.url),i=this.blacklistRelayUrls?.has(t.url),r=t.url.includes("/npub1"),n=!0,a=t.url;if(s)return;if(i){this.debug(`Refusing to add relay ${a}: blacklisted`);return}if(r){this.debug(`Refusing to add relay ${a}: is a filter relay`);return}if(this.ndk.cacheAdapter?.getRelayStatus){let s=this.ndk.cacheAdapter.getRelayStatus(a);if(s&&s.dontConnectBefore){if(s.dontConnectBefore>Date.now()){let i=s.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${a}: delayed connect for ${i}ms`),setTimeout(()=>{this.addRelay(t,e)},i);return}n=!1}}let o=e=>this.emit("notice",t,e),h=()=>this.handleRelayConnect(a),l=()=>this.handleRelayReady(t),u=()=>this.emit("relay:disconnect",t),c=()=>this.handleFlapping(t),d=e=>this.emit("relay:auth",t,e),p=()=>this.emit("relay:authed",t);t.off("notice",o),t.off("connect",h),t.off("ready",l),t.off("disconnect",u),t.off("flapping",c),t.off("auth",d),t.off("authed",p),t.on("notice",o),t.on("connect",h),t.on("ready",l),t.on("disconnect",u),t.on("flapping",c),t.on("auth",d),t.on("authed",p),t.on("delayed-connect",e=>{this.ndk.cacheAdapter?.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+e})}),this.relays.set(a,t),e&&this.autoConnectRelays.add(a),e&&(this.emit("relay:connecting",t),t.connect(void 0,n).catch(t=>{this.debug(`Failed to connect to relay ${a}`,t)}))}removeRelay(t){let e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;let s=this.temporaryRelayTimers.get(t);return s&&(clearTimeout(s),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){let e=m(t),s=this.relays.get(e);return!!s&&5===s.status}getRelay(t,e=!0,s=!1,i){let r=this.relays.get(m(t));return r||((r=new tv(t,void 0,this.ndk)).connectivity.netDebug=this.ndk.netDebug,s?this.useTemporaryRelay(r,3e4,i):this.addRelay(r,e)),r}handleRelayConnect(t){let e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){let e=[];this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}...`:""}`);let s=new Set(this.autoConnectRelays.keys());for(let i of(this.ndk.explicitRelayUrls?.forEach(t=>{let e=m(t);s.add(e)}),s)){let s=this.relays.get(i);if(!s)continue;let r=new Promise((e,i)=>(this.emit("relay:connecting",s),s.connect(t).then(e).catch(i)));if(t){let i=new Promise((e,s)=>{setTimeout(()=>s(`Timed out after ${t}ms`),t)});e.push(Promise.race([r,i]).catch(t=>{this.debug(`Failed to connect to relay ${s.url}: ${t??"No reason specified"}`)}))}else e.push(r)}t&&setTimeout(()=>{let t=this.stats().connected===this.relays.size,e=this.stats().connected>0;!t&&e&&this.emit("connect")},t),await Promise.all(e)}checkOnFlappingRelays(){if(this.flappingRelays.size/this.relays.size>=.8)for(let t of this.flappingRelays)this.backoffTimes.set(t,0)}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e*=2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){let t={total:0,connected:0,disconnected:0,connecting:0};for(let e of this.relays.values())t.total++,5===e.status?t.connected++:1===e.status?t.disconnected++:4===e.status&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}};function tR(t){return!!(t.filter.ids&&function(t){let e=t.filter.ids;return!!e&&e.length===t.eventFirstSeen.size}(t))}function tT(t,e){if(Object.keys(t).length!==Object.keys(e).length)return!1;for(let[s,i]of Object.entries(t)){let t=e[s];if(!t)return!1;if(Array.isArray(i)&&Array.isArray(t)){for(let e of t)if(!i.includes(e))return!1}else if(t!==i)return!1}return!0}function tS(t,e){let s=t.map(t=>t.subId).filter(Boolean),i=[],r=new Set,n=new Set;if(s.length>0)i.push(Array.from(new Set(s)).join(","));else{for(let t of e)for(let e of Object.keys(t))"kinds"===e?t.kinds?.forEach(t=>n.add(t)):r.add(e);n.size>0&&i.push("kinds:"+Array.from(n).join(",")),r.size>0&&i.push(Array.from(r).join(","))}let a=i.join("-");return a.length>20&&(a=a.substring(0,20)),a+="-"+Math.floor(999*Math.random()).toString()}function tN(t){try{let e=a.Qe.decode(t);switch(e.type){case"naddr":return{"#a":[`${e.data.kind}:${e.data.pubkey}:${e.data.identifier}`]};case"nevent":return{"#e":[e.data.id]};case"note":return{"#e":[e.data]};case"nprofile":return{"#p":[e.data.pubkey]};case"npub":return{"#p":[e.data]}}}catch{}}function tP(t,e){let s=tA(t),i=tC(t,e);return 0===i.length?{filter:s}:{filter:s,relaySet:new S(new Set(i),e)}}function tA(t){let e;if(t.match(tM)){let[e,s,i]=t.split(":"),r={authors:[s],kinds:[parseInt(e)]};return i&&(r["#d"]=[i]),r}if(t.match(tD))try{switch((e=a.Qe.decode(t)).type){case"nevent":{let t={ids:[e.data.id]};return e.data.author&&(t.authors=[e.data.author]),e.data.kind&&(t.kinds=[e.data.kind]),t}case"note":return{ids:[e.data]};case"naddr":let s={authors:[e.data.pubkey],kinds:[e.data.kind]};return e.data.identifier&&(s["#d"]=[e.data.identifier]),s}}catch(e){console.error("Error decoding",t,e)}return{ids:[t]}}function t_(t){return null!==t.match(tM)}var tM=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,tD=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function tC(t,e){try{let s=a.Qe.decode(t);if(["naddr","nevent"].includes(s?.type)){let t=s.data;if(t?.relays)return t.relays.map(t=>new tv(t,e.relayAuthDefaultPolicy,e))}}catch(t){}return[]}var tI=(t=>(t.ONLY_CACHE="ONLY_CACHE",t.CACHE_FIRST="CACHE_FIRST",t.PARALLEL="PARALLEL",t.ONLY_RELAY="ONLY_RELAY",t))(tI||{}),tU={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},tx=class extends r.EventEmitter{subId;filters;opts;pool;skipVerification=!1;skipValidation=!1;relayFilters;relaySet;ndk;debug;eventFirstSeen=new Map;eosesSeen=new Set;lastEventReceivedAt;internalId;closeOnEose;poolMonitor;skipOptimisticPublishEvent=!1;constructor(t,e,s,i,r){if(super(),this.ndk=t,this.pool=s?.pool||t.pool,this.opts={...tU,...s||{}},this.filters=e instanceof Array?e:[e],this.subId=r||s?.subId,this.internalId=Math.random().toString(36).substring(7),this.relaySet=i,this.debug=t.debug.extend(`subscription[${s?.subId??this.internalId}]`),this.skipVerification=s?.skipVerification||!1,this.skipValidation=s?.skipValidation||!1,this.closeOnEose=s?.closeOnEose||!1,this.skipOptimisticPublishEvent=s?.skipOptimisticPublishEvent||!1,"ONLY_CACHE"===this.opts.cacheUsage&&!this.opts.closeOnEose)throw Error("Cannot use cache-only options with a persistent subscription")}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter(t=>!this.eosesSeen.has(this.pool.getRelay(t,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){if(this.isGroupable())return this.opts?.groupableDelay}get groupableDelayType(){return this.opts?.groupableDelayType||"at-most"}isGroupable(){return this.opts?.groupable||!1}shouldQueryCache(){return this.opts?.cacheUsage!=="ONLY_RELAY"}shouldQueryRelays(){return this.opts?.cacheUsage!=="ONLY_CACHE"}shouldWaitForCache(){return this.opts.closeOnEose&&!!this.ndk.cacheAdapter?.locking&&"PARALLEL"!==this.opts.cacheUsage}async start(){let t;if(this.shouldQueryCache()&&(t=this.startWithCache(),this.shouldWaitForCache()&&(await t,tR(this)))){this.emit("eose",this);return}this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{!this.relayFilters?.has(t.url)&&A(this.ndk,this.filters,this.pool).get(t.url)&&(this.relayFilters?.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}onStopped;stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners(),this.onStopped?.()}hasAuthorsFilter(){return this.filters.some(t=>t.authors?.length)}async startWithCache(){if(this.ndk.cacheAdapter?.query){let t=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await t}}startWithRelays(){if(this.relaySet&&0!==this.relaySet.relays.size)for(let t of(this.relayFilters=new Map,this.relaySet.relays))this.relayFilters.set(t.url,this.filters);else this.relayFilters=A(this.ndk,this.filters,this.pool);if(this.relayFilters&&0!==this.relayFilters.size)for(let[t,e]of this.relayFilters)this.pool.getRelay(t,!0,!0,e).subscribe(this,e)}eventReceived(t,e,s=!1,i=!1){let r;let n=t.id,a=this.eventFirstSeen.has(n);if(t instanceof tp&&(r=t),a){let s=Date.now()-(this.eventFirstSeen.get(n)||0);if(this.emit("event:dup",n,e,s,this),e){let s=tl.get(n);s&&"string"==typeof s&&t.sig===s&&e.addValidatedEvent()}}else{if((r??=new tp(this.ndk,t)).ndk=this.ndk,r.relay=e,!s&&!i){if(!this.skipValidation&&!r.isValid){this.debug("Event failed validation %s from relay %s",n,e?.url);return}if(e){if(e?.shouldValidateEvent()!==!1){if(!this.skipVerification){if(r.verifySignature(!0)||this.ndk.asyncSigVerification)e&&e.addValidatedEvent();else{this.debug("Event failed signature validation",t);return}}}else e.addNonValidatedEvent()}this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(r,this.filters,e)}!s&&e&&this.ndk.emit("event",r,e),i&&!0===this.skipOptimisticPublishEvent||(this.emit("event",r,e,this),this.eventFirstSeen.set(n,Date.now()))}this.lastEventReceivedAt=Date.now()}closedReceived(t,e){this.emit("closed",t,e)}eoseTimeout;eosed=!1;eoseReceived(t){this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,s=this.eosesSeen.size===this.relayFilters?.size,i=tR(this),r=t=>{this.debug("Performing EOSE: %s %d",t,this.eosed),this.eosed||(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0)};if(i||s)r("query filled or seen all");else if(this.relayFilters){let t=1e3,s=new Set(this.pool.connectedRelays().map(t=>t.url)),i=Array.from(this.relayFilters.keys()).filter(t=>s.has(t));if(0===i.length)return;let n=this.eosesSeen.size/i.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:n,seen:this.eosesSeen.size,total:i.length}),this.eosesSeen.size>=2&&n>=.5){if(0==(t*=1-n)){r("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);let s=()=>{void 0!==(e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0)&&e<20?this.eoseTimeout=setTimeout(s,t):r("send eose timeout: "+t)};this.eoseTimeout=setTimeout(s,t)}}}};async function tV(t,e,s=3){if(!this.ndk)throw Error("NDK not set");let i=await this.ndk.fetchEvent({kinds:[s],authors:[this.pubkey]},t||{groupable:!1});if(i){let t=new Set;return i.tags.forEach(e=>{"p"===e[0]&&t.add(e[1])}),e&&this.ndk?.outboxTracker?.trackUsers(Array.from(t)),[...t].reduce((t,e)=>{let s=new tG({pubkey:e});return s.ndk=this.ndk,t.add(s),t},new Set)}return new Set}function tL(t){let e;let s={};try{e=JSON.parse(t.content)}catch(t){throw Error(`Failed to parse profile event: ${t}`)}return s.created_at=t.created_at,s.profileEvent=JSON.stringify(t.rawEvent()),Object.keys(e).forEach(t=>{switch(t){case"name":s.name=e.name;break;case"display_name":s.displayName=e.display_name;break;case"image":case"picture":s.image=e.picture||e.image;break;case"banner":s.banner=e.banner;break;case"bio":s.bio=e.bio;break;case"nip05":s.nip05=e.nip05;break;case"lud06":s.lud06=e.lud06;break;case"lud16":s.lud16=e.lud16;break;case"about":s.about=e.about;break;case"zapService":s.zapService=e.zapService;break;case"website":s.website=e.website;break;default:s[t]=e[t]}}),s}function tO(t){let e={};for(let[s,i]of Object.entries(t))switch(s){case"username":case"name":e.name=i;break;case"displayName":e.display_name=i;break;case"image":case"picture":e.picture=i;break;case"bio":case"about":e.about=i;break;default:e[s]=i}return JSON.stringify(e)}var tz=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function tF(t,e,s=fetch,i={}){return await t.queuesNip05.add({id:e,func:async()=>{if(t.cacheAdapter&&t.cacheAdapter.loadNip05){let s=await t.cacheAdapter.loadNip05(e);if("missing"!==s){if(s){let e=new tG({pubkey:s.pubkey,relayUrls:s.relays,nip46Urls:s.nip46});return e.ndk=t,e}if("no-cache"!==i.cache)return null}}let r=e.match(tz);if(!r)return null;let[n,a="_",o]=r;try{let r=await s(`https://${o}/.well-known/nostr.json?name=${a}`,i),{names:n,relays:h,nip46:l}=function(t){let e={names:{}};for(let[s,i]of Object.entries(t.names))"string"==typeof s&&"string"==typeof i&&(e.names[s.toLowerCase()]=i);if(t.relays)for(let[s,i]of(e.relays={},Object.entries(t.relays)))"string"==typeof s&&Array.isArray(i)&&(e.relays[s]=i.filter(t=>"string"==typeof t));if(t.nip46)for(let[s,i]of(e.nip46={},Object.entries(t.nip46)))"string"==typeof s&&Array.isArray(i)&&(e.nip46[s]=i.filter(t=>"string"==typeof t));return e}(await r.json()),u=n[a.toLowerCase()],c=null;return u&&(c={pubkey:u,relays:h?.[u],nip46:l?.[u]}),t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t.cacheAdapter.saveNip05(e,c),c}catch(s){return t?.cacheAdapter&&t.cacheAdapter.saveNip05&&t?.cacheAdapter.saveNip05(e,null),console.error("Failed to fetch NIP05 for",e,s),null}}})}var tK=class t extends tp{static kind=10019;static kinds=[10019];_p2pk;constructor(t,e){super(t,e),this.kind??=10019}static from(e){return new t(e.ndk,e)}set relays(t){for(let e of(this.tags=this.tags.filter(t=>"relay"!==t[0]),t))this.tags.push(["relay",e])}get relays(){let t=[];for(let e of this.tags)"relay"===e[0]&&t.push(e[1]);return t}set mints(t){for(let e of(this.tags=this.tags.filter(t=>"mint"!==t[0]),t))this.tags.push(["mint",e])}get mints(){let t=[];for(let e of this.tags)"mint"===e[0]&&t.push(e[1]);return Array.from(new Set(t))}get p2pk(){return this._p2pk||(this._p2pk=this.tagValue("pubkey")??this.pubkey),this._p2pk}set p2pk(t){this._p2pk=t,this.removeTag("pubkey"),t&&this.tags.push(["pubkey",t])}get relaySet(){return S.fromRelayUrls(this.relays,this.ndk)}},tq=n("ndk:zapper:ln");async function t$({lud06:t,lud16:e},s){let i;if(e&&!e.startsWith("LNURL")){let[t,s]=e.split("@");i=`https://${s}/.well-known/lnurlp/${t}`}else if(t){let{words:e}=c.I.decode(t,1e3),s=c.I.fromWords(e);i=new TextDecoder("utf-8").decode(s)}if(!i)throw tq("No zap endpoint found %o",{lud06:t,lud16:e}),Error("No zap endpoint found");try{let t=s.httpFetch||fetch,e=await t(i);if(200!==e.status){let t=await e.text();throw Error(`Unable to fetch zap endpoint ${i}: ${t}`)}return await e.json()}catch(t){throw Error(`Unable to fetch zap endpoint ${i}: ${t}`)}}var tG=class t{ndk;profile;_npub;_pubkey;relayUrls=[];nip46Urls=[];constructor(t){t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw Error("pubkey not set");this._npub=a.Qe.npubEncode(this.pubkey)}return this._npub}get nprofile(){return console.log("encoding with pubkey",this.pubkey),a.Qe.nprofileEncode({pubkey:this.pubkey})}set npub(t){this._npub=t}get hexpubkey(){return this.pubkey}set hexpubkey(t){this._pubkey=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw Error("npub not set");this._pubkey=a.Qe.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}async getZapInfo(t=!0,e=["nip61","nip57"]){if(!this.ndk)throw Error("No NDK instance found");let s=[];if(e.includes("nip61")&&s.push(10019),e.includes("nip57")&&s.push(0),0===s.length)return[];let i=await this.ndk.fetchEvents({kinds:s,authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",groupable:!1});i.size<e.length&&(i=await this.ndk.fetchEvents({kinds:s,authors:[this.pubkey]},{cacheUsage:"ONLY_RELAY"}));let r=[],n=Array.from(i).find(t=>10019===t.kind),a=Array.from(i).find(t=>0===t.kind);if(n){let e=tK.from(n);if(e.mints.length>0&&r.push({type:"nip61",data:{mints:e.mints,relays:e.relays,p2pk:e.p2pk}}),!t)return r}if(a){let{lud06:t,lud16:e}=tL(a);try{let s=await t$({lud06:t,lud16:e},this.ndk);s&&r.push({type:"nip57",data:s})}catch(t){console.error("Error getting NIP-57 zap spec",t)}}return r}async getZapConfiguration(t){if(!(t??=this.ndk))throw Error("No NDK instance found");let e=async()=>{let e;if(this.ndk?.cacheAdapter?.loadUsersLNURLDoc){let t=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if("missing"!==t){if(null===t)return;if(t)return t}}try{if(await this.fetchProfile({groupable:!1}),this.profile){let{lud06:s,lud16:i}=this.profile;e=await t$({lud06:s,lud16:i},t)}}catch{}if(this.ndk?.cacheAdapter?.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,e||null),e)return e};return await t.queuesZapConfig.add({id:this.pubkey,func:e})}async getZapperPubkey(){let t=await this.getZapConfiguration();return t?.nostrPubkey}static async fromNip05(e,s,i=!1){if(!s)throw Error("No NDK instance found");let r={};i&&(r.cache="no-cache");let n=await tF(s,e,s?.httpFetch,r);if(n){let e=new t({pubkey:n.pubkey,relayUrls:n.relays,nip46Urls:n.nip46});return e.ndk=s,e}}async fetchProfile(t,e=!1){if(!this.ndk)throw Error("NDK not set");this.profile||(this.profile={});let s=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&t?.cacheUsage!=="ONLY_RELAY"){let t=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(t)return this.profile=t,t}!t&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(s=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),t={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),s&&0!==s.size||(s=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},t));let i=Array.from(s).sort((t,e)=>t.created_at-e.created_at);if(0===i.length)return null;let r=i[0];return this.profile=tL(r),e&&(this.profile.profileEvent=JSON.stringify(r)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile}follows=tV.bind(this);async followSet(t,e,s=3){return new Set(Array.from(await this.follows(t,e,s)).map(t=>t.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(t){let e=[["p",this.pubkey]];return t&&e[0].push("",t),e}async publish(){if(!this.ndk)throw Error("No NDK instance found");if(!this.profile)throw Error("No profile available");this.ndk.assertSigner();let t=new tp(this.ndk,{kind:0,content:tO(this.profile)});await t.publish()}async follow(t,e,s=3){if(!this.ndk)throw Error("No NDK instance found");if(this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s)),e.has(t))return!1;e.add(t);let i=new tp(this.ndk,{kind:s});for(let t of e)i.tag(t);return await i.publish(),!0}async unfollow(t,e,s=3){if(!this.ndk)throw Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s));let i=new Set,r=!1;for(let s of e)s.pubkey!==t.pubkey?i.add(s):r=!0;if(!r)return!1;let n=new tp(this.ndk,{kind:s});for(let t of i)n.tag(t);return await n.publish()}async validateNip05(t){if(!this.ndk)throw Error("No NDK instance found");let e=await tF(this.ndk,t);return null===e?null:e.pubkey===this.pubkey}},tj=class t extends tp{_encryptedTags;encryptedTagsLength;constructor(t,e){super(t,e),this.kind??=30001}static from(e){return new t(e.ndk,e)}get title(){let t=this.tagValue("title")||this.tagValue("name");if(t)return t;if(3===this.kind)return"Contacts";if(1e4===this.kind)return"Mute";if(10001===this.kind)return"Pinned Notes";if(10002===this.kind)return"Relay Metadata";if(10003===this.kind)return"Bookmarks";if(10004===this.kind)return"Communities";if(10005===this.kind)return"Public Chats";else if(10006===this.kind)return"Blocked Relays";else if(10007===this.kind)return"Search Relays";else if(10050===this.kind)return"Direct Message Receive Relays";else if(10015===this.kind)return"Interests";else if(10030===this.kind)return"Emojis";else return this.tagValue("d")}set title(t){this.removeTag(["title","name"]),t&&this.tags.push(["title",t])}get name(){return this.title}set name(t){this.title=t}get description(){return this.tagValue("description")}set description(t){this.removeTag("description"),t&&this.tags.push(["description",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(t=!0){if(t&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");let e=await this.ndk.signer.user();try{if(this.content.length>0)try{let t=await this.ndk.signer.decrypt(e,this.content),s=JSON.parse(t);if(s&&s[0])return this.encryptedTagsLength=this.content.length,this._encryptedTags=s;return this.encryptedTagsLength=this.content.length,this._encryptedTags=[]}catch(t){console.log(`error decrypting ${this.content}`)}}catch(t){}return[]}validateTag(t){return!0}getItems(t){return this.tags.filter(e=>e[0]===t)}get items(){return this.tags.filter(t=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(t[0]))}async addItem(t,e,s=!1,i="bottom"){let r;if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(t instanceof tp)r=[t.tagReference(e)];else if(t instanceof tG)r=t.referenceTags();else if(t instanceof tv)r=t.referenceTags();else if(Array.isArray(t))r=[t];else throw Error("Invalid object type");if(e&&r[0].push(e),s){let t=await this.ndk.signer.user(),e=await this.encryptedTags();"top"===i?e.unshift(...r):e.push(...r),this._encryptedTags=e,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(e),await this.encrypt(t)}else"top"===i?this.tags.unshift(...r):this.tags.push(...r);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(t,e=!0){if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");let s=this.tags.findIndex(e=>e[1]===t);s>=0&&this.tags.splice(s,1);let i=await this.ndk.signer.user(),r=await this.encryptedTags(),n=r.findIndex(e=>e[1]===t);if(n>=0&&(r.splice(n,1),this._encryptedTags=r,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(r),await this.encrypt(i)),e)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(t,e){if(!this.ndk)throw Error("NDK instance not set");if(!this.ndk.signer)throw Error("NDK signer not set");if(e){let e=await this.ndk.signer.user(),s=await this.encryptedTags();s.splice(t,1),this._encryptedTags=s,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(s),await this.encrypt(e)}else this.tags.splice(t,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(t){return this.items.some(e=>e[1]===t)}filterForItems(){let t=new Set,e=new Map,s=[];for(let s of this.items)if("e"===s[0]&&s[1])t.add(s[1]);else if("a"===s[0]&&s[1]){let[t,i,r]=s[1].split(":");if(!t||!i)continue;let n=`${t}:${i}`,a=e.get(n)||[];a.push(r||""),e.set(n,a)}if(t.size>0&&s.push({ids:Array.from(t)}),e.size>0)for(let[t,i]of e.entries()){let[e,r]=t.split(":");s.push({kinds:[parseInt(e)],authors:[r],"#d":i})}return s}};async function tH(t,e,s,i){if(!t.ndk)throw Error("No NDK instance found");if(t.ndk.assertSigner(),!s){let e=await t.ndk.fetchEvents({kinds:[10001],authors:[t.pubkey]},{cacheUsage:"ONLY_RELAY"});s=e.size>0?tj.from(Array.from(e)[0]):new tp(t.ndk,{kind:10001})}return s.tag(e),i&&await s.publish(),s}var tJ=class t extends tp{static kind=30023;static kinds=[30023];constructor(t,e){super(t,e),this.kind??=30023}static from(e){return new t(e.ndk,e)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}get summary(){return this.tagValue("summary")}set summary(t){this.removeTag("summary"),t&&this.tags.push(["summary",t])}get published_at(){let t=this.tagValue("published_at");if(t){let e=parseInt(t);return e>1e12&&(e=Math.floor(e/1e3)),e}}set published_at(t){this.removeTag("published_at"),void 0!==t&&this.tags.push(["published_at",t.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(t){t?this.tags.push(["url",t]):this.removeTag("url")}},tW=class extends tJ{static kind=30818;static kinds=[30818]},tB=class t extends tp{constructor(t,e){super(t,e),this.kind??=30402}static from(e){return new t(e.ndk,e)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get summary(){return this.tagValue("summary")}set summary(t){this.removeTag("summary"),t&&this.tags.push(["summary",t])}get published_at(){let t=this.tagValue("published_at");if(t)return parseInt(t)}set published_at(t){this.removeTag("published_at"),void 0!==t&&this.tags.push(["published_at",t.toString()])}get location(){return this.tagValue("location")}set location(t){this.removeTag("location"),t&&this.tags.push(["location",t])}get price(){let t=this.tags.find(t=>"price"===t[0]);return t?{amount:parseFloat(t[1]),currency:t[2],frequency:t[3]}:void 0}set price(t){if("string"==typeof t&&(t={amount:parseFloat(t)}),t?.amount){let e=["price",t.amount.toString()];t.currency&&e.push(t.currency),t.frequency&&e.push(t.frequency),this.tags.push(e)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},tQ=class t extends tp{static kind=34235;static kinds=[34235,34236];constructor(t,e){super(t,e),this.kind??=34235}static from(e){return new t(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get thumbnail(){return this.tagValue("thumb")}set thumbnail(t){this.removeTag("thumb"),t&&this.tags.push(["thumb",t])}get url(){return this.tagValue("url")}set url(t){this.removeTag("url"),t&&this.tags.push(["url",t])}get published_at(){let t=this.tagValue("published_at");if(t)return parseInt(t)}set published_at(t){this.removeTag("published_at"),void 0!==t&&this.tags.push(["published_at",t.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get duration(){let t=this.tagValue("duration");if(t)return parseInt(t)}set duration(t){this.removeTag("duration"),void 0!==t&&this.tags.push(["duration",Math.floor(t).toString()])}},tY=class t extends tp{_article;static kind=9802;static kinds=[9802];constructor(t,e){super(t,e),this.kind??=9802}static from(e){return new t(e.ndk,e)}get url(){return this.tagValue("r")}set context(t){void 0===t?this.tags=this.tags.filter(([t,e])=>"context"!==t):(this.tags=this.tags.filter(([t,e])=>"context"!==t),this.tags.push(["context",t]))}get context(){return this.tags.find(([t,e])=>"context"===t)?.[1]??void 0}get article(){return this._article}set article(t){this._article=t,"string"==typeof t?this.tags.push(["r",t]):this.tag(t)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){let t;if(void 0!==this._article)return this._article;let e=this.getArticleTag();if(e){switch(e[0]){case"a":let[s,i,r]=e[1].split(":");t=a.Qe.naddrEncode({kind:parseInt(s),pubkey:i,identifier:r});break;case"e":t=a.Qe.noteEncode(e[1]);break;case"r":this._article=e[1]}if(t){let e=await this.ndk?.fetchEvent(t);e&&(30023===e.kind&&(e=tJ.from(e)),this._article=e)}return this._article}}},tZ="read",tX="write",t0=class t extends tp{constructor(t,e){super(t,e),this.kind??=10002}static from(e){return new t(e.ndk,e.rawEvent())}get readRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]||t[2]&&t[2]===tZ).map(t=>f(t[1])).filter(t=>!!t)}set readRelayUrls(t){for(let e of t)this.tags.push(["r",e,tZ])}get writeRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]||t[2]&&t[2]===tX).map(t=>f(t[1])).filter(t=>!!t)}set writeRelayUrls(t){for(let e of t)this.tags.push(["r",e,tX])}get bothRelayUrls(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).filter(t=>!t[2]).map(t=>t[1])}set bothRelayUrls(t){for(let e of t)this.tags.push(["r",e])}get relays(){return this.tags.filter(t=>"r"===t[0]||"relay"===t[0]).map(t=>t[1])}get relaySet(){if(!this.ndk)throw Error("NDKRelayList has no NDK instance");return new S(new Set(this.relays.map(t=>this.ndk.pool.getRelay(t))),this.ndk)}};function t1(t,e){try{let s=JSON.parse(e.content),i=new t0(t),r=new Set,n=new Set;for(let[t,e]of Object.entries(s)){try{t=m(t)}catch{continue}e?(e.write&&n.add(t),e.read&&r.add(t)):(r.add(t),n.add(t))}return i.readRelayUrls=Array.from(r),i.writeRelayUrls=Array.from(n),i}catch{}}var t3=class t extends tp{_event;constructor(t,e){super(t,e),this.kind??=31234}static from(e){return new t(e.ndk,e)}set identifier(t){this.removeTag("d"),this.tags.push(["d",t])}get identifier(){return this.dTag}set event(t){t instanceof tp?this._event=t.rawEvent():this._event=t,this.prepareEvent()}async getEvent(t){if(this._event)return new tp(this.ndk,this._event);if(!(t??=this.ndk?.signer))throw Error("No signer available");let e=await t.user();if(!this.content||!(this.content.length>0))return null;try{await this.decrypt(e,t);let s=JSON.parse(this.content);return this._event=s,new tp(this.ndk,s)}catch(t){console.error(t);return}}prepareEvent(){if(!this._event)throw Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event)}async save({signer:t,publish:e,relaySet:s}){if(!(t??=this.ndk?.signer))throw Error("No signer available");let i=await t.user();if(await this.encrypt(i,t),!1!==e)return this.publish(s)}},t4=class t extends tp{_repostedEvents;constructor(t,e){super(t,e)}static from(e){return new t(e.ndk,e.rawEvent())}async repostedEvents(t,e){let s=[];if(!this.ndk)throw Error("NDK instance not set");if(void 0!==this._repostedEvents)return this._repostedEvents;for(let i of this.repostedEventIds()){let r=function(t){if(!t.match(/:/))return{ids:[t]};{let[e,s,i]=t.split(":");return{kinds:[parseInt(e)],authors:[s],"#d":[i]}}}(i),n=await this.ndk.fetchEvent(r,e);n&&s.push(t?t.from(n):n)}return s}repostedEventIds(){return this.tags.filter(t=>"e"===t[0]||"a"===t[0]).map(t=>t[1])}},t2=class t extends tp{profile;constructor(t,e){super(t,e),this.kind??=31990}static from(e){return new t(e.ndk,e.rawEvent())}async fetchProfile(){if(void 0===this.profile&&this.content.length>0)try{let t=JSON.parse(this.content);if(t&&t.name)return t;this.profile=null}catch(t){this.profile=null}return new Promise((t,e)=>{let s=this.author;s.fetchProfile().then(()=>{t(s.profile)}).catch(e)})}},t5=["daily","weekly","monthly","quarterly","yearly"];function t6(t){switch(t){case"daily":return 86400;case"weekly":return 604800;case"monthly":return 2592e3;case"quarterly":return 7776e3;case"yearly":return 31536e3}}function t9(t,e,s){return["amount",t.toString(),e,s]}function t7(t){let e=parseInt(t[1]);if(isNaN(e)||null==e||e<=0)return;let s=t[2];if(void 0===s||""===s)return;let i=t[3];if(void 0!==i&&t5.includes(i))return{amount:e,currency:s,term:i}}var t8=class t extends tJ{static kind=37001;static kinds=[37001];constructor(t,e){let s=e?.kind??37001;super(t,e),this.kind=s}static from(e){return new t(e.ndk,e)}get perks(){return this.getMatchingTags("perk").map(t=>t[1]).filter(t=>void 0!==t)}addPerk(t){this.tags.push(["perk",t])}get amounts(){return this.getMatchingTags("amount").map(t=>t7(t)).filter(t=>void 0!==t)}addAmount(t,e,s){this.tags.push(t9(t,e,s))}set relayUrl(t){this.tags.push(["r",t])}get relayUrls(){return this.getMatchingTags("r").map(t=>t[1]).filter(t=>void 0!==t)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(t){this.removeTag("p"),t&&this.tags.push(["p",t])}get isValid(){return void 0!==this.title&&this.amounts.length>0}},et=class t extends tp{debug;constructor(t,e){super(t,e),this.kind??=7001,this.debug=t?.debug.extend("subscription-start")??n("ndk:subscription-start")}static from(e){return new t(e.ndk,e.rawEvent())}get recipient(){let t=this.getMatchingTags("p")?.[0];if(t)return new tG({pubkey:t[1]})}set recipient(t){this.removeTag("p"),t&&this.tags.push(["p",t.pubkey])}get amount(){let t=this.getMatchingTags("amount")?.[0];if(t)return t7(t)}set amount(t){this.removeTag("amount"),t&&this.tags.push(t9(t.amount,t.currency,t.term))}get tierId(){let t=this.getMatchingTags("e")?.[0],e=this.getMatchingTags("a")?.[0];if(t&&e)return t[1]??e[1]}set tier(t){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),t&&(this.tag(t),this.removeTag("p"),this.tags.push(["p",t.pubkey]),this.tags.push(["event",JSON.stringify(t.rawEvent())]))}async fetchTier(){let t=this.tagValue("event");if(t)try{let e=JSON.parse(t);return new t8(this.ndk,e)}catch{this.debug("Failed to parse event tag")}let e=this.tierId;if(!e)return;let s=await this.ndk?.fetchEvent(e);if(s)return t8.from(s)}get isValid(){return 1!==this.getMatchingTags("amount").length?(this.debug("Invalid # of amount tag"),!1):this.amount?1!==this.getMatchingTags("p").length?(this.debug("Invalid # of p tag"),!1):!!this.recipient||(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},ee=class t extends tp{debug;constructor(t,e){super(t,e),this.kind??=7003,this.debug=t?.debug.extend("subscription-start")??n("ndk:subscription-start")}static from(e){return new t(e.ndk,e.rawEvent())}get recipient(){let t=this.getMatchingTags("p")?.[0];if(t)return new tG({pubkey:t[1]})}set recipient(t){this.removeTag("p"),t&&this.tags.push(["p",t.pubkey])}get subscriber(){let t=this.getMatchingTags("P")?.[0];if(t)return new tG({pubkey:t[1]})}set subscriber(t){this.removeTag("P"),t&&this.tags.push(["P",t.pubkey])}set subscriptionStart(t){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(t,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){let t=this.getMatchingTags("tier")?.[0];return t?.[1]}get isValid(){let t=this.validPeriod;if(!t||t.start>t.end)return!1;let e=this.getMatchingTags("p"),s=this.getMatchingTags("P");return 1===e.length&&1===s.length}get validPeriod(){let t=this.getMatchingTags("valid")?.[0];if(t)try{return{start:new Date(1e3*parseInt(t[1])),end:new Date(1e3*parseInt(t[2]))}}catch{return}}set validPeriod(t){this.removeTag("valid"),t&&this.tags.push(["valid",Math.floor(t.start.getTime()/1e3).toString(),Math.floor(t.end.getTime()/1e3).toString()])}get startPeriod(){return this.validPeriod?.start}get endPeriod(){return this.validPeriod?.end}isActive(t){t??=new Date;let e=this.validPeriod;return!!e&&!(t<e.start)&&!(t>e.end)}},es=(t=>(t.Processing="processing",t.Success="success",t.Scheduled="scheduled",t.PayReq="payment_required",t))(es||{}),ei=class t extends tp{constructor(t,e){super(t,e),this.kind??=7e3}static async from(e){let s=new t(e.ndk,e.rawEvent());return s.encrypted&&await s.dvmDecrypt(),s}get status(){return this.tagValue("status")}set status(t){this.removeTag("status"),void 0!==t&&this.tags.push(["status",t])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();let t=JSON.parse(this.content);this.tags.push(...t)}},er=class t extends tp{constructor(t,e){super(t,e)}static from(e){return new t(e.ndk,e.rawEvent())}set bid(t){void 0===t?this.removeTag("bid"):this.tags.push(["bid",t.toString()])}get bid(){let t=this.tagValue("bid");if(void 0!==t)return parseInt(t)}addInput(...t){this.tags.push(["i",...t])}addParam(...t){this.tags.push(["param",...t])}set output(t){void 0===t?this.removeTag("output"):("string"==typeof t&&(t=[t]),this.tags.push(["output",...t]))}get output(){let t=this.getMatchingTags("output")[0];return t?t.slice(1):void 0}get params(){return this.getMatchingTags("param").map(t=>t.slice(1))}getParam(t){let e=this.getMatchingTags("param").find(e=>e[1]===t);return e?e[2]:void 0}createFeedback(t){let e=new ei(this.ndk);return e.tag(this,"job"),e.status=t,e}async encryption(t,e){let s=["i","param","output","relays","bid"],i=this.tags.filter(t=>s.includes(t[0]));this.tags=this.tags.filter(t=>!s.includes(t[0])),this.content=JSON.stringify(i),this.tag(t),this.tags.push(["encrypted"]),await this.encrypt(t,e)}set dvm(t){this.removeTag("p"),t&&this.tag(t)}},en=class t extends er{constructor(t,e){super(t,e),this.kind=5e3}static from(e){return new t(e.ndk,e.rawEvent())}get url(){let t=this.getMatchingTags("i");if(1===t.length)return t[0][1]}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}},ea=class t extends tp{constructor(t,e){super(t,e)}static from(e){return new t(e.ndk,e.rawEvent())}setAmount(t,e){this.removeTag("amount");let s=["amount",t.toString()];e&&s.push(e),this.tags.push(s)}set result(t){void 0===t?this.content="":this.content=t}get result(){if(""!==this.content)return this.content}set status(t){this.removeTag("status"),void 0!==t&&this.tags.push(["status",t])}get status(){return this.tagValue("status")}get jobRequestId(){for(let t of this.getMatchingTags("e"))if("job"===t[2])return t[1];return this.jobRequest?this.jobRequest.id:this.tagValue("e")}set jobRequest(t){this.removeTag("request"),t&&(this.kind=t.kind+1e3,this.tags.push(["request",JSON.stringify(t.rawEvent())]),this.tag(t))}get jobRequest(){let t=this.tagValue("request");if(void 0!==t)return new tp(this.ndk,JSON.parse(t))}},eo=class t extends tp{debug;_proofs=[];static kind=9321;static kinds=[t.kind];constructor(t,e){super(t,e),this.kind??=9321,this.debug=t?.debug.extend("nutzap")??n("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(t){let e=new this(t.ndk,t);try{let t=e.getMatchingTags("proof");t.length?e._proofs=t.map(t=>JSON.parse(t[1])):e._proofs=JSON.parse(e.content)}catch{return}if(e._proofs&&e._proofs.length)return e}set comment(t){this.content=t??""}get comment(){return this.tagValue("comment")||this.content}set proofs(t){for(let e of(this._proofs=t,this.tags=this.tags.filter(t=>"proof"!==t[0]),t))this.tags.push(["proof",JSON.stringify(e)]);this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()])}get proofs(){return this._proofs}get p2pk(){let t=this.proofs[0];try{let e=JSON.parse(t.secret),s={};if("string"==typeof e?(s=JSON.parse(e),this.debug("stringified payload",t.secret)):"object"==typeof e&&(s=e),"P2PK"===s[0]&&s[1]?.data){let t=s[1].data.slice(2,-1);if(t)return t}}catch(t){this.debug("error parsing p2pk pubkey",t,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(t){this.removeTag("u"),this.tag(["u",t])}get unit(){return this.tagValue("unit")??"msat"}set unit(t){this.removeTag("unit"),t&&this.tag(["unit",t])}get amount(){return 1e3*this.proofs.reduce((t,e)=>t+e.amount,0)}sender=this.author;set target(t){this.tags=this.tags.filter(t=>"p"!==t[0]),t instanceof tp&&this.tags.push(t.tagReference())}set recipientPubkey(t){this.removeTag("p"),this.tag(["p",t])}get recipientPubkey(){return this.tagValue("p")}get recipient(){let t=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:t}):new tG({pubkey:t})}get isValid(){let t=0,e=0;for(let s of this.tags)"p"===s[0]&&t++,"u"===s[0]&&e++;return 1===t&&1===e&&this.proofs.length>0}},eh=class t extends tp{relaySet;memberSet=new Set;static kind=39002;static kinds=[39002];constructor(t,e){super(t,e),this.kind??=39002,this.memberSet=new Set(this.members)}static from(e){return new t(e.ndk,e)}get members(){return this.getMatchingTags("p").map(t=>t[1])}hasMember(t){return this.memberSet.has(t)}async publish(t,e,s){return t??=this.relaySet,super.publishReplaceable(t,e,s)}},el=class t extends tp{static kind=39e3;static kinds=[39e3];constructor(t,e){super(t,e),this.kind??=39e3}static from(e){return new t(e.ndk,e)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){return this.getMatchingTags("public").length>0?"public":this.getMatchingTags("public").length>0?"private":void 0}set scope(t){this.removeTag("public"),this.removeTag("private"),"public"===t?this.tags.push(["public",""]):"private"===t&&this.tags.push(["private",""])}get access(){return this.getMatchingTags("open").length>0?"open":this.getMatchingTags("closed").length>0?"closed":void 0}set access(t){this.removeTag("open"),this.removeTag("closed"),"open"===t?this.tags.push(["open",""]):"closed"===t&&this.tags.push(["closed",""])}},eu=class t{ndk;groupId;relaySet;fetchingMetadata;metadata;memberList;adminList;constructor(t,e,s){this.ndk=t,this.groupId=s??function(t){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=e.length,i="";for(let t=0;t<24;t++)i+=e.charAt(Math.floor(Math.random()*s));return i}(0),this.relaySet=e}get id(){return this.groupId}relayUrls(){return this.relaySet.relayUrls}get name(){return this.metadata?.name}get about(){return this.metadata?.about}get picture(){return this.metadata?.picture}get members(){return this.memberList?.members??[]}get admins(){return this.adminList?.members??[]}async getMetadata(){return await this.ensureMetadataEvent(),this.metadata}async createGroup(t){if(!(t??=this.ndk.signer))throw Error("No signer available");if(!await t.user())throw Error("No user available");let e=new tp(this.ndk);return e.kind=9007,e.tags.push(["h",this.groupId]),await e.sign(t),e.publish(this.relaySet)}async setMetadata({name:t,about:e,picture:s}){let i=new tp(this.ndk);return i.kind=9002,i.tags.push(["h",this.groupId]),t&&i.tags.push(["name",t]),e&&i.tags.push(["about",e]),s&&i.tags.push(["picture",s]),await i.sign(),i.publish(this.relaySet)}async addUser(e){let s=t.generateAddUserEvent(e.pubkey,this.groupId);return s.ndk=this.ndk,s}async getMemberListEvent(){let t=await this.ndk.fetchEvent({kinds:[39002],"#d":[this.groupId]},void 0,this.relaySet);return t?eh.from(t):null}async getMembers(){let t=[],e=new Set,s=await this.getMemberListEvent();if(!s)return[];for(let i of s.getMatchingTags("p")){let s=i[1];if(!e.has(s)){e.add(s);try{t.push(this.ndk.getUser({pubkey:s}))}catch{}}}return t}static generateUserListEvent(t){return new tp(void 0,{kind:39002,tags:[["h",t],["alt","Group Member List"]]})}static generateAddUserEvent(t,e){let s=new tp(void 0,{kind:9e3,tags:[["h",e]]});return s.tags.push(["p",t]),s}async requestToJoin(t,e){return new tp(this.ndk,{kind:9021,content:e??"",tags:[["h",this.groupId]]}).publish(this.relaySet)}async ensureMetadataEvent(){if(!this.metadata)return this.fetchingMetadata||(this.fetchingMetadata=this.ndk.fetchEvent({kinds:[39e3],"#d":[this.groupId]},void 0,this.relaySet).then(t=>{t?this.metadata=el.from(t):(this.metadata=new el(this.ndk),this.metadata.dTag=this.groupId)}).finally(()=>{this.fetchingMetadata=void 0}).catch(()=>{throw Error("Failed to fetch metadata for group "+this.groupId)})),this.fetchingMetadata}},ec=class t extends tp{appName;settings={};constructor(t,e){if(super(t,e),this.kind??=30078,this.dTag??=this.appName,this.content.length>0)try{this.settings=JSON.parse(this.content)}catch(t){console.error("Error parsing app settings",t)}}static from(e){return new t(e.ndk,e)}set(t,e){this.settings[t]=e}get(t){return this.settings[t]}async publishReplaceable(t,e,s){return this.content=JSON.stringify(this.settings),super.publishReplaceable(t,e,s)}};async function ed(t,e,s,i,r,n){try{await t.sign(s),r(t)}catch(s){i(`Failed to publish auth event to relay ${e.url}`,s),n(t)}}var ep={disconnect:function(t,e){return e??=n("ndk:relay:auth-policies:disconnect"),async s=>{e(`Relay ${s.url} requested authentication, disconnecting`),t.removeRelay(s.url)}},signIn:function({ndk:t,signer:e,debug:s}={}){return s??=n("ndk:auth-policies:signIn"),async(i,r)=>{s(`Relay ${i.url} requested authentication, signing in`);let n=new tp(t);return n.kind=22242,n.tags=[["relay",i.url],["challenge",r]],e??=t?.signer,new Promise(async(r,a)=>{e?await ed(n,i,e,s,r,a):t?.once("signer:ready",async t=>{await ed(n,i,t,s,r,a)})})}}},eg=class{_userPromise;nip04Queue=[];nip04Processing=!1;debug;waitTimeout;constructor(t=1e3){this.debug=n("ndk:nip07"),this.waitTimeout=t}async blockUntilReady(){await this.waitForExtension();let t=await window.nostr.getPublicKey();if(!t)throw Error("User rejected access");return new tG({pubkey:t})}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}async sign(t){return await this.waitForExtension(),(await window.nostr.signEvent(t)).sig}async relays(t){await this.waitForExtension();let e=await window.nostr.getRelays?.()||{},s=[];for(let t of Object.keys(e))e[t].read&&e[t].write&&s.push(t);return s.map(e=>new tv(e,t?.relayAuthDefaultPolicy,t))}async encrypt(t,e,s=V){return"nip44"===s?this.nip44Encrypt(t,e):this.nip04Encrypt(t,e)}async decrypt(t,e,s=V){return"nip44"===s?this.nip44Decrypt(t,e):this.nip04Decrypt(t,e)}async nip44Encrypt(t,e){return await this.waitForExtension(),await this.nip44.encrypt(t.pubkey,e)}get nip44(){if(!window.nostr?.nip44)throw Error("NIP-44 not supported by your browser extension");return window.nostr.nip44}async nip44Decrypt(t,e){return await this.waitForExtension(),await this.nip44.decrypt(t.pubkey,e)}async nip04Encrypt(t,e){await this.waitForExtension();let s=t.pubkey;return this.queueNip04("encrypt",s,e)}async nip04Decrypt(t,e){await this.waitForExtension();let s=t.pubkey;return this.queueNip04("decrypt",s,e)}async queueNip04(t,e,s){return new Promise((i,r)=>{this.nip04Queue.push({type:t,counterpartyHexpubkey:e,value:s,resolve:i,reject:r}),this.nip04Processing||this.processNip04Queue()})}async processNip04Queue(t,e=0){if(!t&&0===this.nip04Queue.length){this.nip04Processing=!1;return}this.nip04Processing=!0;let{type:s,counterpartyHexpubkey:i,value:r,resolve:n,reject:a}=t||this.nip04Queue.shift();try{let t;t="encrypt"===s?await window.nostr.nip04.encrypt(i,r):await window.nostr.nip04.decrypt(i,r),n(t)}catch(n){if(n.message&&n.message.includes("call already executing")&&e<5){this.debug("Retrying encryption queue item",{type:s,counterpartyHexpubkey:i,value:r,retries:e}),setTimeout(()=>{this.processNip04Queue(t,e+1)},50*e);return}a(n)}this.processNip04Queue()}waitForExtension(){return new Promise((t,e)=>{let s;if(window.nostr){t();return}let i=setInterval(()=>{window.nostr&&(clearTimeout(s),clearInterval(i),t())},100);s=setTimeout(()=>{clearInterval(i),e(Error("NIP-07 extension not available"))},this.waitTimeout)})}},ey=class t{_user;_privateKey;constructor(t){if(t){if("string"==typeof t){if(t.startsWith("nsec1")){let{type:e,data:s}=a.Qe.decode(t);"nsec"===e&&(this._privateKey=s)}else if(64===t.length)this._privateKey=(0,h.aT)(t);else throw Error("Invalid private key provided.")}else this._privateKey=t;this._privateKey&&(this._user=new tG({pubkey:(0,a.lG)(this._privateKey)}))}}get privateKey(){if(this._privateKey)return(0,h.My)(this._privateKey)}static generate(){return new t((0,a.Bq)())}async blockUntilReady(){if(!this._user)throw Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return(0,a.pC)(t,this._privateKey).sig}getConversationKey(t){if(!this._privateKey)throw Error("Attempted to get conversation key without a private key");let e=t.pubkey;return a.Q5.getConversationKey(this._privateKey,e)}async nip44Encrypt(t,e){let s=this.getConversationKey(t);return await a.Q5.encrypt(e,s)}async nip44Decrypt(t,e){let s=this.getConversationKey(t);return await a.Q5.decrypt(e,s)}async encrypt(t,e,s=V){return"nip44"===s?this.nip44Encrypt(t,e):this.nip04Encrypt(t,e)}async decrypt(t,e,s=V){return"nip44"===s?this.nip44Decrypt(t,e):this.nip04Decrypt(t,e)}async nip04Encrypt(t,e){if(!this._privateKey)throw Error("Attempted to encrypt without a private key");let s=t.pubkey;return await a.sh.encrypt(this._privateKey,s,e)}async nip04Decrypt(t,e){if(!this._privateKey)throw Error("Attempted to decrypt without a private key");let s=t.pubkey;return await a.sh.decrypt(this._privateKey,s,e)}},ef=class extends r.EventEmitter{ndk;signer;relaySet;debug;encryptionType="nip04";pool;constructor(t,e,s,i){if(super(),this.ndk=t,this.signer=e,i)for(let r of(this.pool=new tE(i,Array.from(t.pool.blacklistRelayUrls),t,s.extend("rpc-pool")),this.pool.name="nostr-rpc",this.relaySet=new S(new Set,t,this.pool),i)){let i=this.pool.getRelay(r,!1,!1);i.authPolicy=ep.signIn({ndk:t,signer:e,debug:s}),this.relaySet.addRelay(i),i.connect()}this.debug=s.extend("rpc")}subscribe(t){let e=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool},this.relaySet,!1);return e.on("event",async t=>{try{let e=await this.parseEvent(t);e.method?this.emit("request",e):this.emit(`response-${e.id}`,e)}catch(e){this.debug("error parsing event",e,t.rawEvent())}}),new Promise(t=>{e.on("eose",()=>{this.debug("eosed"),t(e)}),e.start()})}async parseEvent(t){let e;"nip44"===this.encryptionType&&t.content.includes("?iv=")?this.encryptionType="nip04":"nip04"!==this.encryptionType||t.content.includes("?iv=")||(this.encryptionType="nip44");let s=this.ndk.getUser({pubkey:t.pubkey});s.ndk=this.ndk;try{e=await this.signer.decrypt(s,t.content,this.encryptionType)}catch(r){let i="nip04"===this.encryptionType?"nip44":"nip04";e=await this.signer.decrypt(s,t.content,i),this.encryptionType=i}let{id:i,method:r,params:n,result:a,error:o}=JSON.parse(e);return r?{id:i,pubkey:t.pubkey,method:r,params:n,event:t}:{id:i,result:a,error:o,event:t}}async sendResponse(t,e,s,i=24133,r){let n={id:t,result:s};r&&(n.error=r);let a=await this.signer.user(),o=this.ndk.getUser({pubkey:e}),h=new tp(this.ndk,{kind:i,content:JSON.stringify(n),tags:[["p",e]],pubkey:a.pubkey});h.content=await this.signer.encrypt(o,h.content,this.encryptionType),await h.sign(this.signer),await h.publish(this.relaySet)}async sendRequest(t,e,s=[],i=24133,r){let n=Math.random().toString(36).substring(7),a=await this.signer.user(),o=this.ndk.getUser({pubkey:t}),h=new Promise(()=>{let t=e=>{"auth_url"===e.result?(this.once(`response-${n}`,t),this.emit("authUrl",e.error)):r&&r(e)};this.once(`response-${n}`,t)}),l=new tp(this.ndk,{kind:i,content:JSON.stringify({id:n,method:e,params:s}),tags:[["p",t]],pubkey:a.pubkey});return l.content=await this.signer.encrypt(o,l.content,this.encryptionType),await l.sign(this.signer),await l.publish(this.relaySet),h}},em=class{async handle(t,e,s,i){let r=t.debug.extend("ping");if(r(`ping request from ${s}`),await t.pubkeyAllowed({id:e,pubkey:s,method:"ping"}))return r(`connection request from ${s} allowed`),"pong";r(`connection request from ${s} rejected`)}},eb=class{async handle(t,e,s,i){let[r,n]=i,a=t.debug.extend("connect");if(a(`connection request from ${s}`),n&&t.applyToken&&(a("applying token"),await t.applyToken(s,n)),await t.pubkeyAllowed({id:e,pubkey:s,method:"connect",params:n}))return a(`connection request from ${s} allowed`),"ack";a(`connection request from ${s} rejected`)}},ek=class{async handle(t,e,s,i){return t.localUser?.pubkey}},ew=class{async handle(t,e,s,i){let[r,n]=i,a=new tG({pubkey:r});return await ev(t,e,s,a,n)}};async function ev(t,e,s,i,r){if(!await t.pubkeyAllowed({id:e,pubkey:s,method:"nip04_decrypt",params:r})){t.debug(`decrypt request from ${s} rejected`);return}return await t.signer.decrypt(i,r,"nip04")}var eE=class{async handle(t,e,s,i){let[r,n]=i,a=new tG({pubkey:r});return await eR(t,e,s,a,n)}};async function eR(t,e,s,i,r){if(!await t.pubkeyAllowed({id:e,pubkey:s,method:"nip04_encrypt",params:r})){t.debug(`encrypt request from ${s} rejected`);return}return await t.signer.encrypt(i,r,"nip04")}var eT=class{async handle(t,e,s,i){let r=await eS(t,e,s,i);if(r)return JSON.stringify(await r.toNostrEvent())}};async function eS(t,e,s,i){let[r]=i;t.debug(`sign event request from ${s}`);let n=new tp(t.ndk,JSON.parse(r));if(t.debug("event to sign",n.rawEvent()),!await t.pubkeyAllowed({id:e,pubkey:s,method:"sign_event",params:n})){t.debug(`sign event request from ${s} rejected`);return}return t.debug(`sign event request from ${s} allowed`),await n.sign(t.signer),n}var eN=class{async handle(t,e,s,i){let[r,n]=i,a=new tG({pubkey:r});return await eP(t,e,s,a,n)}};async function eP(t,e,s,i,r){if(!await t.pubkeyAllowed({id:e,pubkey:s,method:"nip44_encrypt",params:r})){t.debug(`encrypt request from ${s} rejected`);return}return await t.signer.encrypt(i,r,"nip44")}var eA=class{async handle(t,e,s,i){let[r,n]=i,a=new tG({pubkey:r});return await e_(t,e,s,a,n)}};async function e_(t,e,s,i,r){if(!await t.pubkeyAllowed({id:e,pubkey:s,method:"nip44_decrypt",params:r})){t.debug(`decrypt request from ${s} rejected`);return}return await t.signer.decrypt(i,r,"nip44")}var eM=class{ndk;signer;localUser;debug;rpc;permitCallback;relayUrls;constructor(t,e,s,i){if(this.ndk=t,e instanceof Uint8Array)this.signer=new ey(e);else if(e instanceof String)this.signer=new ey((0,h.aT)(e));else if(e instanceof ey)this.signer=e;else throw Error("Invalid signer");this.debug=t.debug.extend("nip46:backend"),this.relayUrls=i??Array.from(t.pool.relays.keys()),this.rpc=new ef(t,this.signer,this.debug,this.relayUrls),this.permitCallback=s}async start(){this.localUser=await this.signer.user(),this.ndk.subscribe({kinds:[24133],"#p":[this.localUser.pubkey]},{closeOnEose:!1}).on("event",t=>this.handleIncomingEvent(t))}handlers={connect:new eb,sign_event:new eT,nip04_encrypt:new eE,nip04_decrypt:new ew,nip44_encrypt:new eN,nip44_decrypt:new eA,get_public_key:new ek,ping:new em};setStrategy(t,e){this.handlers[t]=e}async applyToken(t,e){throw Error("connection token not supported")}async handleIncomingEvent(t){let e;let{id:s,method:i,params:r}=await this.rpc.parseEvent(t),n=t.pubkey;if(this.debug("incoming event",{id:s,method:i,params:r}),!t.verifySignature(!1)){this.debug("invalid signature",t.rawEvent());return}let a=this.handlers[i];if(a)try{e=await a.handle(this,s,n,r)}catch(t){this.debug("error handling event",t,{id:s,method:i,params:r}),this.rpc.sendResponse(s,n,"error",void 0,t.message)}else this.debug("unsupported method",{method:i,params:r});e?(this.debug(`sending response to ${n}`,e),this.rpc.sendResponse(s,n,e)):this.rpc.sendResponse(s,n,"error",void 0,"Not authorized")}async pubkeyAllowed(t){return this.permitCallback(t)}},eD=class extends r.EventEmitter{ndk;_user;bunkerPubkey;userPubkey;secret;localSigner;nip05;rpc;debug;relayUrls;subscription;constructor(t,e,s){super(),this.ndk=t,this.debug=t.debug.extend("nip46:signer"),e.startsWith("bunker://")?this.connectionTokenInit(e):this.nip05Init(e),s?this.localSigner=s:this.localSigner=ey.generate(),this.rpc=new ef(this.ndk,this.localSigner,this.debug,this.relayUrls)}connectionTokenInit(t){let e=new URL(t),s=e.hostname||e.pathname.replace(/^\/\//,""),i=e.searchParams.get("pubkey"),r=e.searchParams.getAll("relay"),n=e.searchParams.get("secret");this.bunkerPubkey=s,this.userPubkey=i,this.relayUrls=r,this.secret=n}nip05Init(t){this.nip05=t}get remotePubkey(){return this.userPubkey}async startListening(){if(this.subscription)return;let t=await this.localSigner.user();if(!t)throw Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[t.pubkey]})}async user(){if(!this._user&&!this.userPubkey)throw Error("Remote user not ready");return this._user??=new tG({pubkey:this.userPubkey}),this._user}async blockUntilReady(){if(this.nip05&&!this.userPubkey){let t=await tG.fromNip05(this.nip05,this.ndk);t&&(this._user=t,this.userPubkey=t.pubkey,this.relayUrls=t.nip46Urls,this.rpc=new ef(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...t)=>{this.emit("authUrl",...t)}),new Promise((t,e)=>{let s=[this.userPubkey??""];if(this.secret&&s.push(this.secret),!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",s,24133,s=>{"ack"===s.result?this.getPublicKey().then(e=>{this.userPubkey=e,this._user=new tG({pubkey:e}),t(this._user)}):e(s.error)})})}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((t,e)=>{if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,e=>{t(e.result)})})}async encrypt(t,e){return this.nip04Encrypt(t,e)}async decrypt(t,e){return this.nip04Decrypt(t,e)}async nip04Encrypt(t,e){return this._encrypt(t,e,"nip04")}async nip04Decrypt(t,e){return this._decrypt(t,e,"nip04")}async nip44Encrypt(t,e){return this._encrypt(t,e,"nip44")}async nip44Decrypt(t,e){return this._decrypt(t,e,"nip44")}async _encrypt(t,e,s){return new Promise((i,r)=>{if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,s+"_encrypt",[t.pubkey,e],24133,t=>{t.error?r(t.error):i(t.result)})})}async _decrypt(t,e,s){return new Promise((i,r)=>{if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,s+"_decrypt",[t.pubkey,e],24133,t=>{t.error?r(t.error):i(t.result)})})}async sign(t){return new Promise((e,s)=>{if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(t)],24133,t=>{t.error?s(t.error):e(JSON.parse(t.result).sig)})})}async createAccount(t,e,s){await this.startListening();let i=[];return t&&i.push(t),e&&i.push(e),s&&i.push(s),new Promise((t,e)=>{if(!this.bunkerPubkey)throw Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",i,24133,s=>{s.error?e(s.error):t(s.result)})})}};async function eC(t,e,s,i=!0,r){let n;t instanceof Array||(t=[t]);let a=t[0].ndk;if(!a)throw Error("NDK not set");for(let s of t){if(!s.sig)throw Error("Event not signed");if(!s.created_at)throw Error("Event has no date");if(!e)throw Error("No DVM specified");if(s.created_at<=Date.now()/1e3)throw Error("Event needs to be in the future")}let o=new er(a,{kind:5905});for(let e of t)o.addInput(JSON.stringify(e.rawEvent()),"text");o.tags.push(...function(t,e){let s=[];if(!e||0===e.length){let s=t.ndk?.pool.relays;e=s?Object.keys(s):void 0}return e&&e.length>0&&s.push(["relays",...e]),s}(t[0],s)),i?await o.encryption(e):o.dvm=e,await o.sign(),r&&(n=a.subscribe({kinds:[6905,7e3],...o.filter()},{groupable:!1,closeOnEose:!1}));let h=new Promise(t=>{setTimeout(()=>{n?.stop(),t("Timeout waiting for an answer from the DVM")},r)}),l=new Promise((t,e)=>{r&&n?.on("event",async s=>{if(n?.stop(),7e3===s.kind){let i=await ei.from(s);if("error"===i.status){let t=i.getMatchingTags("status");e(t?.[2]??i)}else t(i)}t(s)}),o.publish().then(()=>{r||t()})});return new Promise((t,e)=>{r?Promise.race([h,l]).then(e=>{t(e)}).catch(e):l.then(t)})}async function eI(t,e){return(await eU([t],e)).get(t)}async function eU(t,e,s=!1){let i=e.outboxPool||e.pool,r=new Set;for(let t of i.relays.values())r.add(t);let n=new Map,a=new Map,o=new S(r,e);if(e.cacheAdapter?.locking&&!s){let s=await e.fetchEvents({kinds:[3,10002],authors:t},{cacheUsage:"ONLY_CACHE"});for(let t of s)10002===t.kind&&n.set(t.pubkey,t0.from(t));for(let t of s)if(3===t.kind){if(n.has(t.pubkey))continue;let s=t1(e,t);s&&a.set(t.pubkey,s)}t=t.filter(t=>!n.has(t)&&!a.has(t))}if(0===t.length)return n;let h=new Map,l=new Map;return new Promise(async s=>{let r=e.subscribe({kinds:[3,10002],authors:t},{closeOnEose:!0,pool:i,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},o,!1);r.on("event",t=>{if(10002===t.kind){let e=h.get(t.pubkey);e&&e.created_at>t.created_at||h.set(t.pubkey,t)}else if(3===t.kind){let e=l.get(t.pubkey);if(e&&e.created_at>t.created_at)return;l.set(t.pubkey,t)}}),r.on("eose",()=>{for(let t of h.values())n.set(t.pubkey,t0.from(t));for(let s of t){if(n.has(s))continue;let t=l.get(s);if(!t)continue;let i=t1(e,t);i&&n.set(s,i)}s(n)}),r.start()})}var ex=class{type;relayUrlScores;readRelays;writeRelays;constructor(t){this.type=t,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},eV=class extends r.EventEmitter{data;ndk;debug;constructor(t){super(),this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new u.LRUCache({maxSize:1e5,entryExpirationTimeInMS:12e4})}async trackUsers(t,e=!1){let s=[];for(let i=0;i<t.length;i+=400){let r=t.slice(i,i+400).map(t=>eL(t)).filter(t=>!this.data.has(t));if(0!==r.length){for(let t of r)this.data.set(t,new ex("user"));s.push(new Promise(t=>{eU(r,this.ndk,e).then(t=>{for(let[e,s]of t){let t=this.data.get(e);if(t??=new ex("user"),s){for(let e of(t.readRelays=new Set(b(s.readRelayUrls)),t.writeRelays=new Set(b(s.writeRelayUrls)),t.readRelays))this.ndk.pool.blacklistRelayUrls.has(e)&&t.readRelays.delete(e);for(let e of t.writeRelays)this.ndk.pool.blacklistRelayUrls.has(e)&&t.writeRelays.delete(e);this.data.set(e,t)}}}).finally(t)}))}}return Promise.all(s)}track(t,e,s=!0){let i=eL(t);e??=t instanceof tG?"user":"kind";let r=this.data.get(i);return!r&&(r=new ex(e),t instanceof tG&&this.trackUsers([t])),r}};function eL(t){return t instanceof tG?t.pubkey:t}function eO(t){if(!t||""===t)return!1;try{return new URL(t),!0}catch(t){return!1}}async function ez(t,e,s,i={type:"timeout"}){let r;let n=this.debug.extend("fetch-event-from-tag"),[a,o,h]=t;n("fetching event from tag",t,s={},i);let l=p(this,e.pubkey);if(l&&l.size>0){n("fetching event from author relays %o",Array.from(l));let t=S.fromRelayUrls(Array.from(l),this),e=await this.fetchEvent(o,s,t);if(e)return e}else n("no author relays found for %s",e.pubkey,e);n("fetching event without relay hint",A(this,[{ids:[o]}],this.pool));let u=await this.fetchEvent(o,s);if(u)return u;if(h&&""!==h){let t=await this.fetchEvent(o,s,this.pool.getRelay(h,!0,!0,[{ids:[o]}]));if(t)return t}let c=eO(h)?this.pool.getRelay(h,!1,!0,[{ids:[o]}]):void 0,d=new Promise(t=>{this.fetchEvent(o,s,c).then(t)});if(!eO(h)||"none"===i.type)return d;let g=new Promise(async t=>{let e=i.relaySet,a=i.timeout??1500,h=new Promise(t=>setTimeout(t,a));"timeout"===i.type&&await h,r?t(r):(n("fallback fetch triggered"),t(await this.fetchEvent(o,s,e)))});switch(i.type){case"timeout":return Promise.race([d,g]);case"eose":if(r=await d)return r;return g}}var eF=class{ndk;spec;url;nip98Required=!1;constructor(t,e){this.url=`https://${t}/.well-known/nostr/nip96.json`,this.ndk=e}async prepareUpload(t,e="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw Error("Failed to fetch NIP96 spec");let s={};return this.nip98Required&&(s={Authorization:await this.generateNip98Header(this.spec.api_url,e,t)}),{url:this.spec.api_url,headers:s}}async xhrUpload(t,e){let s="POST",{url:i,headers:r}=await this.prepareUpload(e,s);t.open(s,i,!0),r.Authorization&&t.setRequestHeader("Authorization",r.Authorization);let n=new FormData;return n.append("file",e),new Promise((e,s)=>{t.onload=function(){t.status>=200&&t.status<300?e(JSON.parse(t.responseText)):s(Error(t.statusText))},t.onerror=function(){s(Error("Network Error"))},t.send(n)})}async upload(t){let e="POST",{url:s,headers:i}=await this.prepareUpload(t,e),r=new FormData;r.append("file",t);let n=await this.ndk.httpFetch(this.spec.api_url,{method:e,headers:i,body:r});if(200!==n.status)throw Error(`Failed to upload file to ${s}`);let a=await n.json();if("success"!==a.status)throw Error(a.message);return a}validateHttpFetch(){if(!this.ndk)throw Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();let t=await this.ndk.httpFetch(this.url);if(200!==t.status)throw Error(`Failed to fetch NIP96 spec from ${this.url}`);let e=await t.json();if(!e)throw Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=e,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(t,e,s){let i=new tp(this.ndk,{kind:27235,tags:[["u",t],["method",e]]});if(["POST","PUT","PATCH"].includes(e)){let t=await this.calculateSha256(s);i.tags.push(["payload",t])}await i.sign();let r=btoa(JSON.stringify(i.rawEvent()));return`Nostr ${r}`}async calculateSha256(t){let e=await t.arrayBuffer();return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",e))).map(t=>t.toString(16).padStart(2,"0")).join("")}},eK=class{queue=[];maxConcurrency;processing=new Set;promises=new Map;constructor(t,e){this.maxConcurrency=e}add(t){if(this.promises.has(t.id))return this.promises.get(t.id);let e=new Promise((e,s)=>{this.queue.push({...t,func:()=>t.func().then(t=>(e(t),t),t=>{throw s(t),t})}),this.process()});return this.promises.set(t.id,e),e.finally(()=>{this.promises.delete(t.id),this.processing.delete(t.id),this.process()}),e}process(){if(this.processing.size>=this.maxConcurrency||0===this.queue.length)return;let t=this.queue.shift();!t||this.processing.has(t.id)||(this.processing.add(t.id),t.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},eq=class{subscriptions;seenEvents=new Map;debug;constructor(t){this.subscriptions=new Map,this.debug=t.extend("sub-manager")}add(t){this.subscriptions.set(t.internalId,t),t.onStopped&&console.log("SUB-MANAGER BUG: Subscription already had onStopped! \uD83E\uDD14",t.internalId),t.onStopped=()=>{this.subscriptions.delete(t.internalId)},t.on("close",()=>{this.subscriptions.delete(t.internalId)})}seenEvent(t,e){let s=this.seenEvents.get(t)||[];s.push(e),this.seenEvents.set(t,s)}filterMatchingTime=0;filterMatchingCount=0;dispatchEvent(t,e,s=!1){e&&this.seenEvent(t.id,e);let i=this.subscriptions.values(),r=[],n=Date.now();for(let e of i)(0,a.XN)(e.filters,t)&&r.push(e);for(let e of(this.filterMatchingTime+=Date.now()-n,this.filterMatchingCount+=r.length,r))e.eventReceived(t,void 0,!1,s)}},e$=n("ndk:active-user");async function eG(t){if(!this.autoConnectUserRelays)return;let e=await eI(t.pubkey,this);if(e){for(let t of e.relays){let e=this.pool.relays.get(t);e||(e=new tv(t,this.relayAuthDefaultPolicy,this),this.pool.addRelay(e))}return e}}async function ej(t){let e=this.outboxPool||this.pool;e.connectedRelays.length>0?eH.call(this,t):e.once("connect",()=>{eH.call(this,t)})}async function eH(t){let e=await eG.call(this,t),s=[{kinds:[10006],authors:[t.pubkey]}];this.autoFetchUserMutelist&&s[0].kinds.push(1e4);let i=e?e.relaySet:void 0,r=this.subscribe(s,{subId:"active-user-settings",closeOnEose:!0},i,!1),n=new Map;r.on("event",t=>{let e=n.get(t.kind);e&&e.created_at>=t.created_at||n.set(t.kind,t)}),r.on("eose",()=>{for(let t of n.values())eJ.call(this,t)}),r.start()}async function eJ(t){10006===t.kind?eW.call(this,t):1e4===t.kind&&eB.call(this,t)}function eW(t){let e=tj.from(t);for(let t of e.items)this.pool.blacklistRelayUrls.add(t[0]);e$("Added %d relays to relay blacklist",e.items.length)}function eB(t){let e=tj.from(t);for(let t of e.items)this.mutedIds.set(t[1],t[0]);e$("Added %d users to mute list",e.items.length)}var eQ=["wss://purplepag.es/","wss://nos.lol/"],eY=["wss://brb.io/","wss://nostr.mutinywallet.com/"],eZ=class extends r.EventEmitter{_explicitRelayUrls;pool;outboxPool;_signer;_activeUser;cacheAdapter;debug;devWriteRelaySet;outboxTracker;mutedIds;clientName;clientNip89;queuesZapConfig;queuesNip05;asyncSigVerification=!1;initialValidationRatio=1;lowestValidationRatio=1;validationRatioFn;subManager;publishingFailureHandled=!1;relayAuthDefaultPolicy;httpFetch;netDebug;autoConnectUserRelays=!0;autoFetchUserMutelist=!0;walletConfig;constructor(t={}){super(),this.debug=t.debug||n("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new eq(this.debug),this.pool=new tE(t.explicitRelayUrls||[],t.blacklistRelayUrls||eY,this),this.pool.name="main",this.pool.on("relay:auth",async(t,e)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(t,e)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.autoFetchUserMutelist=t.autoFetchUserMutelist??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel&&(this.outboxPool=new tE(t.outboxRelayUrls||eQ,t.blacklistRelayUrls||eY,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new eV(this)),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.mutedIds=t.mutedIds||new Map,t.devWriteRelayUrls&&(this.devWriteRelaySet=S.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new eK("zaps",3),this.queuesNip05=new eK("nip05",10),this.signatureVerificationWorker=t.signatureVerificationWorker,this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t,this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this.asyncSigVerification=!!t,t&&((i=t).onmessage=t=>{let[e,s]=t.data,i=tn[e];if(!i){console.error("No record found for event",e);return}for(let t of(delete tn[e],i.resolves))t(s)})}addExplicitRelay(t,e,s=!0){let i;return i="string"==typeof t?new tv(t,e,this):t,this.pool.addRelay(i,s),this.explicitRelayUrls.push(i.url),i}toJSON(){return({relayCount:this.pool.relays.size}).toString()}get activeUser(){return this._activeUser}set activeUser(t){let e=this._activeUser?.pubkey!==t?.pubkey;this._activeUser=t,t&&e?ej.call(this,t):t||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t?.user().then(t=>{t.ndk=this,this.activeUser=t})}async connect(t){this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await this._signer.relays?.(this)),this._signer.relays&&(await this._signer.relays(this)).forEach(t=>this.pool.addRelay(t)));let e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),this.debug("Connecting to relays %o",{timeoutMs:t}),Promise.allSettled(e).then(()=>{})}getUser(t){let e=new tG(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return tG.fromNip05(t,this,e)}subscribe(t,e,s,i=!0){let r=new tx(this,t,e,s);this.subManager.add(r);let n=e?.pool??this.pool;if(s)for(let t of s.relays)n.useTemporaryRelay(t,void 0,r.filters);if(this.outboxPool&&r.hasAuthorsFilter()){let t=r.filters.filter(t=>t.authors&&t.authors?.length>0).map(t=>t.authors).flat();this.outboxTracker?.trackUsers(t)}return i&&setTimeout(()=>r.start(),0),r}async publish(t,e,s){return this.debug("Deprecated: Use `event.publish()` instead"),t.publish(e,s)}fetchEventFromTag=ez.bind(this);async fetchEvent(t,e,s){let i,r;if(s instanceof tv?r=new S(new Set([s]),this):s instanceof S&&(r=s),!s&&"string"==typeof t&&!t_(t)){let e=tC(t,this);e.length>0&&(r=function(t,e){let s=e.connectedRelays();if(!Array.from(t.relays).some(t=>s.map(t=>t.url).includes(t.url)))for(let e of s)t.addRelay(e);if(0===s.length)for(let s of e.relays.values())t.addRelay(s);return t}(r=new S(new Set(e),this),this.pool))}if(0===(i="string"==typeof t?[tA(t)]:Array.isArray(t)?t:[t]).length)throw Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise(t=>{let s=null,n=this.subscribe(i,{...e||{},closeOnEose:!0},r,!1),a=setTimeout(()=>{n.stop(),t(s)},1e4);n.on("event",e=>{e.ndk=this,e.isReplaceable()?(!s||s.created_at<e.created_at)&&(s=e):(clearTimeout(a),t(e))}),n.on("eose",()=>{clearTimeout(a),t(s)}),n.start()})}async fetchEvents(t,e,s){return new Promise(i=>{let r=new Map,n=this.subscribe(t,{...e||{},closeOnEose:!0},s,!1);n.on("event",t=>{t instanceof tp||(t=new tp(void 0,t));let e=t.deduplicationKey(),s=r.get(e);if(s){var i;i=t,t=s.created_at>i.created_at?s:i}t.ndk=this,r.set(e,t)}),n.on("eose",()=>{i(new Set(r.values()))}),n.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),Error("Signer required")}getNip96(t){return new eF(t,this)}set wallet(t){if(console.log("setting wallet",{lnPay:t?.lnPay,cashuPay:t?.cashuPay}),!t){this.walletConfig=void 0;return}this.walletConfig??={},this.walletConfig.lnPay=t?.lnPay?.bind(t),this.walletConfig.cashuPay=t?.cashuPay?.bind(t)}};function eX(t){let e,s;let i=t.getMatchingTags("description")[0],r=t.getMatchingTags("bolt11")[0];if(!i||!r||!r[1])return null;try{let t=i[1];if(t.startsWith("%")&&(t=decodeURIComponent(t)),""===t)return null;s=JSON.parse(t),e=(0,d.decode)(r[1])}catch(t){return null}let n=e.sections.find(t=>"amount"===t.name);if(!n)return null;let a=parseInt(n.value);if(!a)return null;let o=s.content,h=s.pubkey,l=t.getMatchingTags("p")[0][1],u=t.getMatchingTags("e")[0];u||(u=t.getMatchingTags("a")[0]);let c=u?u[1]:void 0;return{id:t.id,zapper:t.pubkey,zappee:h,zapped:l,zappedEvent:c,amount:a,comment:o}}async function e0(t,e,s,i,r,n,o,h,l){let u=s.callback,c=a._Y.makeZapRequest({profile:i,event:null,amount:r,comment:o||"",relays:n.slice(0,4)});if(t instanceof tp){let e=t.referenceTags().filter(t=>"p"!==t[0]);c.tags.push(...e)}c.tags.push(["lnurl",u]);let d=new tp(e,c);return h&&(d.tags=d.tags.concat(h)),d.hasTag("a")&&(d.tags=d.tags.filter(t=>"e"!==t[0])),d.tags=d.tags.filter(t=>"p"!==t[0]),d.tags.push(["p",i]),await d.sign(l),d}var e1=n("ndk:zapper"),e3=class extends r.EventEmitter{target;ndk;comment;amount;unit;tags;signer;zapMethod;lnPay;cashuPay;onComplete;maxRelays=3;constructor(t,e,s="msat",i={}){if(super(),this.target=t,this.ndk=i.ndk||t.ndk,!this.ndk)throw Error("No NDK instance provided");this.amount=e,this.comment=i.comment,this.unit=s,this.tags=i.tags,this.signer=i.signer,this.lnPay=i.lnPay||this.ndk.walletConfig?.lnPay,this.cashuPay=i.cashuPay||this.ndk.walletConfig?.cashuPay,this.onComplete=i.onComplete||this.ndk.walletConfig?.onPaymentComplete}async zap(){let t=this.getZapSplits(),e=new Map;return await Promise.all(t.map(async t=>{let s;try{s=await this.zapSplit(t)}catch(t){s=t}this.emit("split:complete",t,s),e.set(t,s)})),this.emit("complete",e),this.onComplete&&this.onComplete(e),e}async zapNip57(t,e){if(!this.lnPay)throw Error("No lnPay function available");let s=await this.relays(t.pubkey),i=await e0(this.target,this.ndk,e,t.pubkey,t.amount,s,this.comment,this.tags,this.signer);if(!i)throw e1("Unable to generate zap request"),Error("Unable to generate zap request");let r=await this.getLnInvoice(i,t.amount,e);if(!r)throw e1("Unable to get payment request"),Error("Unable to get payment request");return await this.lnPay({target:this.target,recipientPubkey:t.pubkey,paymentDescription:"NIP-57 Zap",pr:r,amount:t.amount,unit:this.unit})}async zapNip61(t,e){let s;if(!this.cashuPay)throw Error("No cashuPay function available");if(e1("NIP-61 Zap result: %o",s=await this.cashuPay({target:this.target,recipientPubkey:t.pubkey,paymentDescription:"NIP-61 Zap",amount:t.amount,unit:this.unit,...e})),s instanceof Error)return s;if(s){let{proofs:e,mint:i}=s;if(!e||!i)throw Error("Invalid zap confirmation: missing proofs or mint: "+s);let r=await this.relays(t.pubkey),n=S.fromRelayUrls(r,this.ndk),a=new eo(this.ndk);return a.tags=[...a.tags,...this.tags||[]],a.proofs=e,a.mint=i,a.target=this.target,a.comment=this.comment,a.unit=this.unit,a.recipientPubkey=t.pubkey,await a.sign(this.signer),a.publish(n),a}}async zapSplit(t){let e;let s=await this.getZapMethods(this.ndk,t.pubkey);if(0===s.length)throw Error("No zap method available for recipient");for(let i of s=s.sort((t,e)=>"nip61"===t.type?-1:"nip61"===e.type?1:0)){e1("Zapping to %s with %d %s using %s",t.pubkey,t.amount,this.unit,i.type);try{if("nip61"===i.type?e=await this.zapNip61(t,i.data):"nip57"===i.type&&(e=await this.zapNip57(t,i.data)),!(e instanceof Error))break}catch(s){e=s instanceof Error?s:Error(s),e1("Error zapping to %s with %d %s using %s: %o",t.pubkey,t.amount,this.unit,i.type,s)}}if(e instanceof Error)throw e;return e}async getLnInvoice(t,e,s){let i=s.callback,r=JSON.stringify(t.rawEvent());e1(`Fetching invoice from ${i}?`+new URLSearchParams({amount:e.toString(),nostr:r}));let n=new URL(i);n.searchParams.append("amount",e.toString()),n.searchParams.append("nostr",r),e1(`Fetching invoice from ${n.toString()}`);let a=await fetch(n.toString());if(e1(`Got response from zap endpoint: ${i}`,{status:a.status}),200!==a.status){e1(`Received non-200 status from zap endpoint: ${i}`,{status:a.status,amount:e,nostr:r});let t=await a.text();throw Error(`Unable to fetch zap endpoint ${i}: ${t}`)}return(await a.json()).pr}getZapSplits(){if(this.target instanceof tG)return[{pubkey:this.target.pubkey,amount:this.amount}];let t=this.target.getMatchingTags("zap");if(0===t.length)return[{pubkey:this.target.pubkey,amount:this.amount}];let e=[],s=t.reduce((t,e)=>t+parseInt(e[2]),0);for(let i of t){let t=i[1],r=Math.floor(parseInt(i[2])/s*this.amount);e.push({pubkey:t,amount:r})}return e}async getZapMethods(t,e){let s=[];if(this.cashuPay&&s.push("nip61"),this.lnPay&&s.push("nip57"),0===s.length)throw Error("There are no payment methods available! Please set at least one of lnPay or cashuPay");let i=t.getUser({pubkey:e}),r=await i.getZapInfo(!1,s);return e1("Zap info for %s: %o",i.npub,r),r}async relays(t){let e=[];if(this.ndk?.activeUser){let s=await eU([this.ndk.activeUser.pubkey,t],this.ndk),i=new Map;for(let t of s.values())for(let e of t.readRelayUrls){let t=i.get(e)||0;i.set(e,t+1)}e=Array.from(i.entries()).sort((t,e)=>e[1]-t[1]).map(([t])=>t).slice(0,this.maxRelays)}return this.ndk?.pool?.permanentAndConnectedRelays().length&&(e=this.ndk.pool.permanentAndConnectedRelays().map(t=>t.url)),e.length||(e=[]),e}}}}]);