(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[451],{3661:(e,t,r)=>{Promise.resolve().then(r.bind(r,2690))},6046:(e,t,r)=>{"use strict";var s=r(6658);r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}}),r.o(s,"useSearchParams")&&r.d(t,{useSearchParams:function(){return s.useSearchParams}})},5798:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var s=r(5155),a=r(7458),i=r(6046),n=r(2115),l=r(9670);function o(){let{ndk:e,user:t,publicKey:r}=(0,a.y)(),o=(0,i.useRouter)(),c=(0,i.useSearchParams)(),[u,d]=(0,n.useState)([]),[p,m]=(0,n.useState)(""),[f,h]=(0,n.useState)(!0),v=(0,n.useRef)(null),x=(0,n.useRef)(!1),[y,g]=(0,n.useState)(void 0),b=c.get("pubkey");(0,n.useEffect)(()=>{b&&r&&e||o.push("/")},[b,r,e,o]),(0,n.useEffect)(()=>(x.current=!0,()=>{x.current=!1}),[]);let w=(0,n.useCallback)(e=>{x.current&&d(e)},[]),j=(0,n.useCallback)(e=>{x.current&&h(e)},[]),k=(0,n.useCallback)(async()=>{if(e&&r&&b)try{let s=window.nostr;if(!(null==s?void 0:s.nip04))throw Error("NIP-04 encryption not supported by extension");let a=e.getUser({pubkey:b});await a.fetchProfile(),x.current&&g(a.profile?{name:a.profile.name,picture:"string"==typeof a.profile.picture?a.profile.picture:void 0}:void 0);let i=await e.fetchEvents({kinds:[4],authors:[r,b],"#p":[b,r]}),n=await Promise.all(Array.from(i).map(e=>(async()=>{try{let i=await s.nip04.decrypt(e.pubkey===r?b:r,e.content),n=e.pubkey===r?(null==t?void 0:t.profile)?{name:t.profile.name,picture:"string"==typeof t.profile.picture?t.profile.picture:void 0}:void 0:a.profile?{name:a.profile.name,picture:"string"==typeof a.profile.picture?a.profile.picture:void 0}:void 0;return{id:e.id,content:i,created_at:e.created_at,pubkey:e.pubkey,profile:n}}catch(s){return console.error("Error decrypting message:",s),{id:e.id,content:"(Unable to decrypt message)",created_at:e.created_at,pubkey:e.pubkey,profile:e.pubkey===r?(null==t?void 0:t.profile)?{name:t.profile.name,picture:"string"==typeof t.profile.picture?t.profile.picture:void 0}:void 0:y}}})()));n.sort((e,t)=>e.created_at-t.created_at),w(n),j(!1),N()}catch(e){console.error("Error loading messages:",e),j(!1)}},[e,r,b,w,j,t,x]),N=(0,n.useCallback)(()=>{var e;null===(e=v.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[]);(0,n.useEffect)(()=>{if(!e||!r||!b)return;k();let s={kinds:[4],authors:[r,b],"#p":[b,r],since:Math.floor(Date.now()/1e3)},a=new Set,i=e.subscribe(s);return i.on("event",async e=>{if(x.current&&!a.has(e.id)){a.add(e.id);try{let s=window.nostr;if(!(null==s?void 0:s.nip04))return;let a=await s.nip04.decrypt(e.pubkey===r?b:r,e.content),i=e.pubkey===r?(null==t?void 0:t.profile)?{name:t.profile.name,picture:"string"==typeof t.profile.picture?t.profile.picture:void 0}:void 0:y,n={id:e.id,content:a,created_at:e.created_at,pubkey:e.pubkey,profile:i};w(e=>e.some(e=>e.id===n.id)?e:[...e,n].sort((e,t)=>e.created_at-t.created_at)),N()}catch(e){console.error("Error processing new message:",e)}}}),()=>{i.stop()}},[e,r,b,w,N,t,y]);let _=async t=>{t.preventDefault();let r=window.nostr;if(!p.trim()||!e||!b||!(null==r?void 0:r.nip04)){console.error("Missing required components for sending message");return}try{let t=await r.nip04.encrypt(b,p),s=new l.NDKEvent(e);s.kind=4,s.content=t,s.tags=[["p",b]],await s.publish(),m("")}catch(e){console.error("Error sending message:",e),alert("Failed to send message. Please try again.")}};return b&&r&&e?f?(0,s.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,s.jsx)("div",{className:"text-2xl text-gray-600",children:"Loading messages..."})}):(0,s.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,s.jsx)("header",{className:"bg-white shadow-sm p-4",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto flex justify-between items-center",children:[(0,s.jsx)("button",{onClick:()=>o.push("/dashboard"),className:"text-gray-600 hover:text-gray-800",children:"← Back to Dashboard"}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden",children:(0,s.jsx)("img",{src:(null==y?void 0:y.picture)||"https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y",alt:(null==y?void 0:y.name)||"Anonymous",className:"w-full h-full object-cover"})}),(0,s.jsxs)("h1",{className:"text-xl font-semibold text-gray-800",children:["Chat with ",(null==y?void 0:y.name)||b.slice(0,8),"..."]})]})]})}),(0,s.jsx)("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto space-y-4",children:[u.map(e=>{var t,a,i,n;return(0,s.jsxs)("div",{className:"flex items-start gap-2 ".concat(e.pubkey===r?"justify-end":"justify-start"),children:[e.pubkey!==r&&(0,s.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0",children:(0,s.jsx)("img",{src:(null===(t=e.profile)||void 0===t?void 0:t.picture)||"https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y",alt:(null===(a=e.profile)||void 0===a?void 0:a.name)||"Anonymous",className:"w-full h-full object-cover"})}),(0,s.jsxs)("div",{className:"max-w-[70%] p-3 rounded-lg ".concat(e.pubkey===r?"bg-custom-green-500 text-white":"bg-white text-gray-800"),children:[(0,s.jsx)("p",{children:e.content}),(0,s.jsx)("p",{className:"text-xs mt-1 ".concat(e.pubkey===r?"text-custom-green-100":"text-gray-500"),children:new Date(1e3*e.created_at).toLocaleString()})]}),e.pubkey===r&&(0,s.jsx)("div",{className:"w-8 h-8 rounded-full overflow-hidden flex-shrink-0",children:(0,s.jsx)("img",{src:(null===(i=e.profile)||void 0===i?void 0:i.picture)||"https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y",alt:(null===(n=e.profile)||void 0===n?void 0:n.name)||"Anonymous",className:"w-full h-full object-cover"})})]},e.id)}),(0,s.jsx)("div",{ref:v})]})}),(0,s.jsx)("div",{className:"bg-white border-t p-4",children:(0,s.jsxs)("form",{onSubmit:_,className:"max-w-4xl mx-auto flex gap-2",children:[(0,s.jsx)("input",{type:"text",value:p,onChange:e=>m(e.target.value),placeholder:"Type your message...",className:"flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-custom-green-500"}),(0,s.jsx)("button",{type:"submit",className:"px-6 py-2 bg-custom-green-500 text-white rounded-lg hover:bg-custom-green-600 disabled:opacity-50",disabled:!p.trim(),children:"Send"})]})})]}):(0,s.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,s.jsx)("div",{className:"text-2xl text-gray-600",children:"Invalid user"})})}},2690:(e,t,r)=>{"use strict";r.d(t,{default:()=>n});var s=r(5155),a=r(6046),i=r(5798);function n(){return(0,a.useSearchParams)().get("pubkey")?(0,s.jsx)(i.A,{}):(0,s.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,s.jsx)("div",{className:"text-2xl text-gray-600",children:"Invalid user"})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[475,951,77,441,517,358],()=>t(3661)),_N_E=e.O()}]);